"use strict";(self.webpackChunkmy_doc=self.webpackChunkmy_doc||[]).push([["7473"],{90758:function(e,r,t){t.r(r),t.d(r,{default:()=>o});var a=t("85893"),i=t("50065");let n=t.p+"static/image/sever-install-gitlab-3.e428f5e7.png",l=t.p+"static/image/sever-install-gitlab-6.77b39c4d.png",s=t.p+"static/image/sever-install-gitlab-4.2e08bee1.png",c=t.p+"static/image/sever-install-gitlab-2.4ec51a16.png",h=t.p+"static/image/sever-install-gitlab-1.51397fca.png";function d(e){let r=Object.assign({h1:"h1",a:"a",p:"p",strong:"strong",h2:"h2",pre:"pre",code:"code",img:"img",h3:"h3",h4:"h4"},(0,i.ah)(),e.components);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(r.h1,{id:"centos7安装gitlab",children:["CentOS7安装GitLab",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#centos7安装gitlab",children:"#"})]}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.strong,{children:"本教程中，防火墙是关闭的。"})}),"\n",(0,a.jsxs)(r.h2,{id:"1-安装ssh",children:["1 安装ssh",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#1-安装ssh",children:"#"})]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"# 检查是否安装了ssh服务\r\nsystemctl status ssh\r\n\r\n# 如果没安装，则安装；安装的话，跳过该命令\r\nyum install -y curl policycoreutils-pythonopenssh-server\r\n\r\n# 设置ssh开机自启\r\nsystemctl enable sshd\r\n\r\n# 启动ssh\r\nsystemctl start sshd\n"})}),"\n",(0,a.jsxs)(r.h2,{id:"2-安装-postfix",children:["2 安装 Postfix",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#2-安装-postfix",children:"#"})]}),"\n",(0,a.jsx)(r.p,{children:"Postfix 是用来发送通知邮件的。"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"# 检查是否安装了postfix服务\r\nsystemctl status postfix\r\n\r\n# 如果没安装，则安装；安装的话，跳过该命令\r\nyum install -y postfix\r\n\r\n# 设置postfix开机自启\r\nsystemctl enable postfix\r\n\r\n# 启动postfix\r\nsystemctl start postfix\n"})}),"\n",(0,a.jsxs)(r.h2,{id:"3-安装-policycoreutils-python",children:["3 安装 policycoreutils-python",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#3-安装-policycoreutils-python",children:"#"})]}),"\n",(0,a.jsx)(r.p,{children:"policycoreutils-python 是gitlab的一个依赖。"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"yum install policycoreutils-python\n"})}),"\n",(0,a.jsxs)(r.h2,{id:"4-安装gitlab",children:["4 安装GitLab",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#4-安装gitlab",children:"#"})]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"# 添加gitlab镜像源\r\nwget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-12.3.5-ce.0.el7.x86_64.rpm\r\n\r\n# 安装\r\nrpm -i gitlab-ce-12.3.5-ce.0.el7.x86_64.rpm\n"})}),"\n",(0,a.jsx)(r.p,{children:"安装过程需要些时间，如果出现下图，则说明安装成功。"}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)("img",{src:h,alt:""})}),"\n",(0,a.jsxs)(r.h2,{id:"5-配置gitlab",children:["5 配置GitLab",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#5-配置gitlab",children:"#"})]}),"\n",(0,a.jsxs)(r.p,{children:["GitLab相关参数配置都在 ",(0,a.jsx)(r.code,{children:"/etc/gitlab/gitlab.rb"})," 文件里，每次配置完成之后需要执行",(0,a.jsx)(r.code,{children:"gitlab-ctl reconfigure"}),"，重新配置才能生效。"]}),"\n",(0,a.jsxs)(r.h3,{id:"51-配置-external_url",children:["5.1 配置 external_url",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#51-配置-external_url",children:"#"})]}),"\n",(0,a.jsxs)(r.p,{children:["修改 external_url ‘[",(0,a.jsx)(r.a,{href:"http://ip:address%5D%E2%80%98%E4%B8%BA%E7%9C%9F%E5%AE%9E%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8IP%E5%92%8C%E7%AB%AF%E5%8F%A3%E3%80%82",target:"_blank",rel:"noopener noreferrer",children:"http://ip:address]‘为真实的服务器IP和端口。"})]}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)("img",{src:c,alt:""})}),"\n",(0,a.jsxs)(r.h3,{id:"52-配置邮件服务",children:["5.2 配置邮件服务",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#52-配置邮件服务",children:"#"})]}),"\n",(0,a.jsx)(r.p,{children:"以qq邮箱向外发送gitlab的相关邮件为例。"}),"\n",(0,a.jsxs)(r.h4,{id:"521-开启qq邮箱的stmp服务",children:["5.2.1 开启qq邮箱的STMP服务",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#521-开启qq邮箱的stmp服务",children:"#"})]}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)("img",{src:s,alt:""})}),"\n",(0,a.jsxs)(r.h4,{id:"522-修改gitlab配置",children:["5.2.2 修改gitlab配置",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#522-修改gitlab配置",children:"#"})]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"# 进入配置文件\r\nvim /etc/gitlab/gitlab.rb\r\n\r\n# 可以在文件中查找这些内容进行修改，由于这些内容是注释的，也可以直接添加\r\ngitlab_rails['smtp_enable'] = true\r\ngitlab_rails['smtp_address'] = \"smtp.qq.com\"\r\ngitlab_rails['smtp_port'] = 465\r\ngitlab_rails['smtp_user_name'] = \"邮箱@qq.com\"\r\ngitlab_rails['smtp_password'] = \"开通smtp时返回的授权码\"\r\ngitlab_rails['smtp_domain'] = \"qq.com\"\r\ngitlab_rails['smtp_authentication'] = \"login\"\r\ngitlab_rails['smtp_enable_starttls_auto'] = true\r\ngitlab_rails['smtp_tls'] = true\r\n\r\nuser['git_user_email'] = \"邮箱@qq.com\"\r\ngitlab_rails['gitlab_email_from'] = '邮箱@qq.com'\n"})}),"\n",(0,a.jsxs)(r.h3,{id:"53-重启gitlab",children:["5.3 重启gitlab",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#53-重启gitlab",children:"#"})]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"# 使修改的配置生效\r\ngitlab-ctl reconfigure\r\n\r\n# 重启\r\ngitlab-ctl restart\n"})}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsxs)(r.strong,{children:[(0,a.jsx)(r.code,{children:"gitlab-ctl reconfigure"}),"（等待时间较长） 若安装过程遇到",(0,a.jsx)(r.code,{children:"“ ruby_block[wait for redis service socket] action run”"}),"处卡住，可通过",(0,a.jsx)(r.code,{children:"ctrl+c"}),"退出，并执行",(0,a.jsx)(r.code,{children:"systemctl restart gitlab-runsvdir"}),"，再继续执行g",(0,a.jsx)(r.code,{children:"itlab-ctl reconfigure"}),"，如安装过程遇到报错信息，可重复执行",(0,a.jsx)(r.code,{children:"gitlab-ctl reconfigure"}),"。"]})}),"\n",(0,a.jsxs)(r.h3,{id:"54-测试邮件是否生效",children:["5.4 测试邮件是否生效",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#54-测试邮件是否生效",children:"#"})]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"# 打开gitlab控制台\r\ngitlab-rails console\r\n\r\n# 发送邮件\r\nNotify.test_email('接收方邮件地址','邮件标题','邮件内容').deliver_now\n"})}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)("img",{src:l,alt:""})}),"\n",(0,a.jsxs)(r.h3,{id:"55-设置root账号密码",children:["5.5 设置root账号密码",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#55-设置root账号密码",children:"#"})]}),"\n",(0,a.jsx)(r.p,{children:"打开浏览器，输入gitlab的ip+端口号，如果未设置root账号的密码，会自动跳转到如下界面，在该界面里便可设置root账号密码。"}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)("img",{src:n,alt:""})}),"\n",(0,a.jsxs)(r.h2,{id:"6-gitlab的迁移",children:["6 gitlab的迁移",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#6-gitlab的迁移",children:"#"})]}),"\n",(0,a.jsxs)(r.h3,{id:"61-gitlab版本的升级",children:["6.1 gitlab版本的升级",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#61-gitlab版本的升级",children:"#"})]}),"\n",(0,a.jsx)(r.p,{children:"gitlab迁移，需要保证两台服务器gitlab版本一致。"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"# 查看gitlab版本号\r\ncat /opt/gitlab/embedded/service/gitlab-rails/VERSION\n"})}),"\n",(0,a.jsx)(r.p,{children:"如果版本号不一致，则需要对gitlab进行升级。"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"# 在带有低版本gitlab的服务器上下载相应高版本的镜像源\r\nwget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-12.3.5-ce.0.el7.x86_64.rpm\r\n\r\n# 关闭部分gitlab服务\r\ngitlab-ctl stop unicorn\r\ngitlab-ctl stop sidekiq\r\ngitlab-ctl stop nginx\r\n\r\n# 升级\r\nrpm -Uvh gitlab-ce-12.3.5-ce.0.el7.x86_64.rpm\r\n\r\n# 重新加载gitlab配置\r\ngitlab-ctl reconfigure\r\n\r\n# 重启gitlab\r\ngitlab-ctl restart\n"})}),"\n",(0,a.jsxs)(r.h3,{id:"62-开始迁移",children:["6.2 开始迁移",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#62-开始迁移",children:"#"})]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"# 备份就数据库数据\r\ngitlab-rake gitlab:backup:create\r\n\r\n# 使用scp命令从本地旧服务器复制文件到新服务器\r\nscp /var/opt/gitlab/backups/1614564759_2021_02_28_12.3.5_gitlab_backup.tar root@xxx.xxx.xxx.xxx:/var/opt/gitlab/backups/\r\n\r\n\r\n# 新服务器恢复GitLab\r\n# 将备份文件权限修改为777，避免出现权限不够的问题\r\ncd /var/opt/gitlab/backups\r\nchomd 777 1614564759_2021_02_28_12.3.5_gitlab_backup.tar \r\n\r\n# 停止数据连接服务\r\ngitlab-ctl stop unicorn\r\ngitlab-ctl stop sidekiq\r\n\r\n# 恢复备份文件到GitLab\r\ngitlab-rake gitlab:backup:restore BACKUP=备份文件编号\r\n#例如：备份文件名为1614564759_2021_02_28_12.3.5_gitlab_backup.tar，则编号为1614564759_2021_02_28_12.3.5。在提示中敲入“yes”继续。\r\n\r\n# 启动\r\ngitlab-ctl start\n"})}),"\n",(0,a.jsxs)(r.h2,{id:"7-卸载gitlab",children:["7 卸载gitlab",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#7-卸载gitlab",children:"#"})]}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.strong,{children:"如不需要，可不操作"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"# 停止gitlab\r\ngitlab-ctl stop\r\n\r\n# 卸载\r\nrpm -e gitlab-ce\r\n\r\n# 查看gitlab进程\r\nps aux | grep gitlab\r\n\r\n# 杀掉第一个进程（就是带有好多.............的进程）\r\nkill -9 XXXXX\r\n\r\n# 删除所有包含gitlab文件\r\nfind / -name gitlab | xargs rm -rf\n"})})]})}function g(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:r}=Object.assign({},(0,i.ah)(),e.components);return r?(0,a.jsx)(r,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}let o=g;g.__RSPRESS_PAGE_META={},g.__RSPRESS_PAGE_META["tang%2Fserver%2FCentOS7%E5%AE%89%E8%A3%85GitLab.md"]={toc:[{text:"1 安装ssh",id:"1-安装ssh",depth:2},{text:"2 安装 Postfix",id:"2-安装-postfix",depth:2},{text:"3 安装 policycoreutils-python",id:"3-安装-policycoreutils-python",depth:2},{text:"4 安装GitLab",id:"4-安装gitlab",depth:2},{text:"5 配置GitLab",id:"5-配置gitlab",depth:2},{text:"5.1 配置 external_url",id:"51-配置-external_url",depth:3},{text:"5.2 配置邮件服务",id:"52-配置邮件服务",depth:3},{text:"5.2.1 开启qq邮箱的STMP服务",id:"521-开启qq邮箱的stmp服务",depth:4},{text:"5.2.2 修改gitlab配置",id:"522-修改gitlab配置",depth:4},{text:"5.3 重启gitlab",id:"53-重启gitlab",depth:3},{text:"5.4 测试邮件是否生效",id:"54-测试邮件是否生效",depth:3},{text:"5.5 设置root账号密码",id:"55-设置root账号密码",depth:3},{text:"6 gitlab的迁移",id:"6-gitlab的迁移",depth:2},{text:"6.1 gitlab版本的升级",id:"61-gitlab版本的升级",depth:3},{text:"6.2 开始迁移",id:"62-开始迁移",depth:3},{text:"7 卸载gitlab",id:"7-卸载gitlab",depth:2}],title:"CentOS7安装GitLab",frontmatter:{}}}}]);