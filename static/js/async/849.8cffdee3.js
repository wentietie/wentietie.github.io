"use strict";(self.webpackChunkmy_doc=self.webpackChunkmy_doc||[]).push([["849"],{39620:function(e,r,n){n.r(r),n.d(r,{default:()=>N});var a=n("85893"),t=n("50065");let s=n.p+"static/image/1616552351873.6e757935.png",i=n.p+"static/image/1616552817376.ab7fa49f.png",l=n.p+"static/image/20200729191908564.76696f70.png",o=n.p+"static/image/20200729191924720.f2244443.png",c=n.p+"static/image/20200729191937113.b0395eb7.png",m=n.p+"static/image/2020072919195143.68f5e606.png",p=n.p+"static/image/2020072919200356.a630cd4b.png",d=n.p+"static/image/20200729192014827.c2edff4b.png",h=n.p+"static/image/2020072919202645.dbb42c7a.png",u=n.p+"static/image/202007291920401.bbeef20d.png",g=n.p+"static/image/20200729192053371.cfd33e68.png",b=n.p+"static/image/2020072919210429.406f4247.png",x=n.p+"static/image/20200729192120498.f9a9cb2e.png",f=n.p+"static/image/20200729192130944.ee3c6074.png",_=n.p+"static/image/20200729192140965.e555963a.png";function k(e){let r=Object.assign({h1:"h1",a:"a",p:"p",hr:"hr",ul:"ul",li:"li",table:"table",thead:"thead",tr:"tr",th:"th",tbody:"tbody",td:"td",pre:"pre",code:"code",h3:"h3",blockquote:"blockquote",em:"em",strong:"strong",img:"img"},(0,t.ah)(),e.components);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(r.h1,{id:"k8s部署prometheus--grafana",children:[(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#k8s部署prometheus--grafana",children:"#"}),"k8s部署prometheus + grafana"]}),"\n",(0,a.jsx)(r.p,{children:"k8s以Deployment方式部署prometheus + grafana："}),"\n",(0,a.jsx)(r.hr,{}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:"主机说明："}),"\n"]}),"\n",(0,a.jsxs)(r.table,{children:[(0,a.jsx)(r.thead,{children:(0,a.jsxs)(r.tr,{children:[(0,a.jsx)(r.th,{align:"left",children:"系统"}),(0,a.jsx)(r.th,{align:"left",children:"ip"}),(0,a.jsx)(r.th,{align:"left",children:"角色"}),(0,a.jsx)(r.th,{align:"left",children:"cpu"}),(0,a.jsx)(r.th,{align:"left",children:"内存"}),(0,a.jsx)(r.th,{align:"left",children:"hostname"})]})}),(0,a.jsxs)(r.tbody,{children:[(0,a.jsxs)(r.tr,{children:[(0,a.jsx)(r.td,{align:"left",children:"CentOS 7.8"}),(0,a.jsx)(r.td,{align:"left",children:"192.168.30.128"}),(0,a.jsx)(r.td,{align:"left",children:"master"}),(0,a.jsx)(r.td,{align:"left",children:">=2"}),(0,a.jsx)(r.td,{align:"left",children:">=2G"}),(0,a.jsx)(r.td,{align:"left",children:"master1"})]}),(0,a.jsxs)(r.tr,{children:[(0,a.jsx)(r.td,{align:"left",children:"CentOS 7.8"}),(0,a.jsx)(r.td,{align:"left",children:"192.168.30.129"}),(0,a.jsx)(r.td,{align:"left",children:"master"}),(0,a.jsx)(r.td,{align:"left",children:">=2"}),(0,a.jsx)(r.td,{align:"left",children:">=2G"}),(0,a.jsx)(r.td,{align:"left",children:"master2"})]}),(0,a.jsxs)(r.tr,{children:[(0,a.jsx)(r.td,{align:"left",children:"CentOS 7.8"}),(0,a.jsx)(r.td,{align:"left",children:"192.168.30.130"}),(0,a.jsx)(r.td,{align:"left",children:"node"}),(0,a.jsx)(r.td,{align:"left",children:">=2"}),(0,a.jsx)(r.td,{align:"left",children:">=2G"}),(0,a.jsx)(r.td,{align:"left",children:"node1"})]}),(0,a.jsxs)(r.tr,{children:[(0,a.jsx)(r.td,{align:"left",children:"CentOS 7.8"}),(0,a.jsx)(r.td,{align:"left",children:"192.168.30.131"}),(0,a.jsx)(r.td,{align:"left",children:"node"}),(0,a.jsx)(r.td,{align:"left",children:">=2"}),(0,a.jsx)(r.td,{align:"left",children:">=2G"}),(0,a.jsx)(r.td,{align:"left",children:"node2"})]}),(0,a.jsxs)(r.tr,{children:[(0,a.jsx)(r.td,{align:"left",children:"CentOS 7.8"}),(0,a.jsx)(r.td,{align:"left",children:"192.168.30.132"}),(0,a.jsx)(r.td,{align:"left",children:"node"}),(0,a.jsx)(r.td,{align:"left",children:">=2"}),(0,a.jsx)(r.td,{align:"left",children:">=2G"}),(0,a.jsx)(r.td,{align:"left",children:"node3"})]})]})]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"[root@master ~]# kubectl get node\r\nNAME     STATUS   ROLES    AGE    VERSION\r\nmaster   Ready    master   141d   v1.19.2\r\nnode1    Ready    <none>   141d   v1.19.2\n"})}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:"采集方案："}),"\n"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-yaml",meta:"",children:"1.通过prometheus-node-exporter采集主机的性能指标数据，并通过暴露的 /metrics 接口用prometheus抓取 \r\n\r\n2.通过kube-apiserver、kube-controller-manager、kube-scheduler、etcd、kubelet、kube-proxy自身暴露的 /metrics 获取节点上与k8s集群相关的一些指标数据 \r\n\r\n3.通过cadvisor采集容器、Pod相关的性能指标数据，并通过暴露的 /metrics 接口用prometheus抓取 通过blackbox-exporter采集应用的网络性能(http、tcp、icmp等)数据，并通过暴露的 /metrics 接口用prometheus抓取 \r\n\r\n4.通过kube-state-metrics采集k8s资源对象的状态指标数据，并通过暴露的 /metrics 接口用prometheus抓取 \r\n\r\n5.应用自己采集容器中进程主动暴露的指标数据（暴露指标的功能由应用自己实现，并添加约定的annotation，prometheus负责根据annotation实现抓取）\n"})}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:"抓取介绍："}),"\n"]}),"\n",(0,a.jsx)(r.p,{children:"Kubernetes可以约定好带哪些annotation前缀的服务是自主暴露监控指标的服务。应用添加约定的这些annotations，Prometheus可以根据annotation实现抓取。例如："}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-json",meta:"",children:"prometheus.io/scrape: 'true'    # 获知对应的endpoint是需要被scrape的 \r\nprometheus.io/app-metrics: 'true'   # 获知对应的endpoint中有应用进程暴露的metrics \r\nprometheus.io/app-metrics-port: '8080'  # 获知进程暴露的metrics的端口 \r\nprometheus.io/app-metrics-path: '/metrics'  # 获知进程暴露的metrics的具体路径\n"})}),"\n",(0,a.jsx)(r.p,{children:"应用可以在service中指定约定的annotation，实现Prometheus对该应用的网络服务进行探测："}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-json",meta:"",children:"http探测:\r\n	prometheus.io/scrape: 'true'    \r\n	prometheus.io/http-probe: 'true'    \r\n	prometheus.io/http-probe-port: '8080'    \r\n	prometheus.io/http-probe-path: '/healthz' \r\ntcp探测:\r\n	prometheus.io/scrape: 'true'    \r\n	prometheus.io/tcp-probe: 'true'    \r\n	prometheus.io/tcp-probe-port: '80'\n"})}),"\n",(0,a.jsx)(r.p,{children:"Prometheus根据这些annotations可以获知相应service是需要被探测的，探测的网络协议可以是http、tcp或其他，以及具体的探测端口。http探测需要知道探测的具体url。"}),"\n",(0,a.jsx)(r.hr,{}),"\n",(0,a.jsxs)(r.h3,{id:"namespace",children:[(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#namespace",children:"#"}),"namespace"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"mkdir -p /home/k8s/monitoring/{node-exporter,k8s,kube-state-metrics,blackbox-exporter,dingtalk,alertmanager,prometheus,grafana} \r\n\r\ncd /home/k8s/monitoring \r\n\r\nvim namespace.yaml\r\n\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-yaml",meta:"",children:"apiVersion: v1\r\nkind: Namespace\r\nmetadata:  \r\n  name: monitoring\n"})}),"\n",(0,a.jsx)(r.hr,{}),"\n",(0,a.jsxs)(r.h3,{id:"node-exporter",children:[(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#node-exporter",children:"#"}),"node-exporter"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"vim node-exporter/node-exporter.yaml\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-yaml",meta:"",children:"apiVersion: v1\r\nkind: Service\r\nmetadata:\r\n  name: node-exporter\r\n  namespace: monitoring\r\n  labels:\r\n    app: node-exporter\r\n  annotations:\r\n    prometheus.io/scrape: 'true'\r\nspec:\r\n  selector:\r\n    app: node-exporter\r\n  ports:\r\n  - name: node-exporter\r\n    port: 9100\r\n    protocol: TCP\r\n    targetPort: 9100\r\n  type: NodePort\r\n \r\n---\r\napiVersion: apps/v1\r\nkind: DaemonSet\r\nmetadata:\r\n  name: node-exporter\r\n  namespace: monitoring\r\n  labels:\r\n    app: node-exporter\r\nspec:\r\n  selector:\r\n    matchLabels:\r\n      app: node-exporter\r\n  template:\r\n    metadata:\r\n      name: node-exporter\r\n      labels:\r\n        app: node-exporter\r\n    spec:\r\n      containers:\r\n      - name: node-exporter\r\n        image: prom/node-exporter:latest\r\n        imagePullPolicy: IfNotPresent\r\n        ports:\r\n        - containerPort: 9100\r\n          hostPort: 9100\r\n      hostNetwork: true\r\n      hostPID: true\r\n      tolerations:\r\n      - key: node-role.kubernetes.io/master\r\n        operator: Exists\r\n        effect: NoSchedule\n"})}),"\n",(0,a.jsx)(r.hr,{}),"\n",(0,a.jsxs)(r.h3,{id:"k8s组件",children:[(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#k8s组件",children:"#"}),"k8s组件"]}),"\n",(0,a.jsx)(r.p,{children:"==controller-manager：=="}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"vim k8s/kube-controller-manager-prometheus-discovery.yaml\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-yaml",meta:"",children:"apiVersion: v1\r\nkind: Service\r\nmetadata:\r\n  name: kube-controller-manager-prometheus-discovery\r\n  namespace: kube-system\r\n  labels:\r\n    component: kube-controller-manager\r\n  annotations:\r\n    prometheus.io/scrape: 'true'\r\nspec:\r\n  selector:\r\n    component: kube-controller-manager\r\n  ports:\r\n  - name: http-metrics\r\n    port: 10252\r\n    targetPort: 10252\r\n    protocol: TCP\r\n  type: NodePort\n"})}),"\n",(0,a.jsx)(r.p,{children:"==kube-scheduler：=="}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"vim k8s/kube-scheduler-prometheus-discovery.yaml\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-yaml",meta:"",children:"apiVersion: v1\r\nkind: Service\r\nmetadata:\r\n  name: kube-scheduler-prometheus-discovery\r\n  namespace: kube-system\r\n  labels:\r\n    component: kube-scheduler\r\n  annotations:\r\n    prometheus.io/scrape: 'true'\r\nspec:\r\n  selector:\r\n    component: kube-scheduler\r\n  ports:\r\n  - name: http-metrics\r\n    port: 10251\r\n    protocol: TCP\r\n    targetPort: 10251\r\n  type: NodePort\n"})}),"\n",(0,a.jsx)(r.p,{children:"==kube-proxy：=="}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"vim k8s/kube-proxy-prometheus-discovery.yaml\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-yaml",meta:"",children:"apiVersion: v1\r\nkind: Service\r\nmetadata:\r\n  name: kube-proxy-prometheus-discovery\r\n  namespace: kube-system\r\n  labels:\r\n    k8s-app: kube-proxy\r\n  annotations:\r\n    prometheus.io/scrape: 'true'\r\nspec:\r\n  selector:\r\n    k8s-app: kube-proxy\r\n  ports:\r\n  - name: http-metrics\r\n    port: 10249\r\n    protocol: TCP\r\n    targetPort: 10249\r\n  type: NodePort\n"})}),"\n",(0,a.jsx)(r.hr,{}),"\n",(0,a.jsxs)(r.h3,{id:"kube-state-metrics",children:[(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#kube-state-metrics",children:"#"}),"kube-state-metrics"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"vim kube-state-metrics/rbac.yaml\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-yaml",meta:"",children:'apiVersion: v1\r\nkind: ServiceAccount\r\nmetadata:\r\n  name: kube-state-metrics\r\n  namespace: monitoring\r\n  labels:\r\n    app: kube-state-metrics\r\n \r\n--- \r\napiVersion: rbac.authorization.k8s.io/v1\r\nkind: ClusterRole\r\nmetadata:\r\n  name: kube-state-metrics\r\n  labels:\r\n    app: kube-state-metrics\r\nrules:\r\n- apiGroups:\r\n  - ""\r\n  resources:\r\n  - configmaps\r\n  - secrets\r\n  - nodes\r\n  - pods\r\n  - services\r\n  - resourcequotas\r\n  - replicationcontrollers\r\n  - limitranges\r\n  - persistentvolumeclaims\r\n  - persistentvolumes\r\n  - namespaces\r\n  - endpoints\r\n  verbs:\r\n  - list\r\n  - watch\r\n- apiGroups:\r\n  - extensions\r\n  resources:\r\n  - daemonsets\r\n  - deployments\r\n  - replicasets\r\n  - ingresses\r\n  verbs:\r\n  - list\r\n  - watch\r\n- apiGroups:\r\n  - apps\r\n  resources:\r\n  - statefulsets\r\n  - daemonsets\r\n  - deployments\r\n  - replicasets\r\n  verbs:\r\n  - list\r\n  - watch\r\n- apiGroups:\r\n  - batch\r\n  resources:\r\n  - cronjobs\r\n  - jobs\r\n  verbs:\r\n  - list\r\n  - watch\r\n- apiGroups:\r\n  - autoscaling\r\n  resources:\r\n  - horizontalpodautoscalers\r\n  verbs:\r\n  - list\r\n  - watch\r\n- apiGroups:\r\n  - authentication.k8s.io\r\n  resources:\r\n  - tokenreviews\r\n  verbs:\r\n  - create\r\n- apiGroups:\r\n  - authorization.k8s.io\r\n  resources:\r\n  - subjectaccessreviews\r\n  verbs:\r\n  - create\r\n- apiGroups:\r\n  - policy\r\n  resources:\r\n  - poddisruptionbudgets\r\n  verbs:\r\n  - list\r\n  - watch\r\n- apiGroups:\r\n  - certificates.k8s.io\r\n  resources:\r\n  - certificatesigningrequests\r\n  verbs:\r\n  - list\r\n  - watch\r\n- apiGroups:\r\n  - storage.k8s.io\r\n  resources:\r\n  - storageclasses\r\n  - volumeattachments\r\n  verbs:\r\n  - list\r\n  - watch\r\n- apiGroups:\r\n  - admissionregistration.k8s.io\r\n  resources:\r\n  - mutatingwebhookconfigurations\r\n  - validatingwebhookconfigurations\r\n  verbs:\r\n  - list\r\n  - watch\r\n- apiGroups:\r\n  - networking.k8s.io\r\n  resources:\r\n  - networkpolicies\r\n  verbs:\r\n  - list\r\n  - watch\r\n- apiGroups:\r\n  - coordination.k8s.io\r\n  resources:\r\n  - leases\r\n  verbs:\r\n  - list\r\n  - watch\r\n  \r\n---\r\napiVersion: rbac.authorization.k8s.io/v1\r\nkind: ClusterRoleBinding\r\nmetadata:\r\n  name: kube-state-metrics\r\n  labels:\r\n    app: kube-state-metrics\r\nroleRef:\r\n  apiGroup: rbac.authorization.k8s.io\r\n  kind: ClusterRole\r\n  name: kube-state-metrics\r\nsubjects:\r\n- kind: ServiceAccount\r\n  name: kube-state-metrics\r\n  namespace: monitoring\n'})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"vim kube-state-metrics/kube-state-metrics.yaml\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-yaml",meta:"",children:"apiVersion: v1\r\nkind: Service\r\nmetadata:\r\n  name: kube-state-metrics\r\n  namespace: monitoring\r\n  labels:\r\n    app: kube-state-metrics\r\n  annotations:\r\n    prometheus.io/scrape: 'true'\r\n    prometheus.io/http-probe: 'true'\r\n    prometheus.io/http-probe-path: '/healthz'\r\n    prometheus.io/http-probe-port: '8080'\r\nspec:\r\n  selector:\r\n    app: kube-state-metrics\r\n  ports:\r\n  - name: kube-state-metrics\r\n    port: 8080\r\n    protocol: TCP\r\n    targetPort: 8080\r\n  type: NodePort\r\n   \r\n---\r\napiVersion: apps/v1\r\nkind: Deployment\r\nmetadata:\r\n  name: kube-state-metrics\r\n  namespace: monitoring\r\n  labels:\r\n    app: kube-state-metrics\r\nspec:\r\n  replicas: 1\r\n  selector:\r\n    matchLabels:\r\n      app: kube-state-metrics\r\n  template:\r\n    metadata:\r\n      labels:\r\n        app: kube-state-metrics\r\n    spec:\r\n      serviceAccountName: kube-state-metrics\r\n      containers:\r\n      - name: kube-state-metrics\r\n        image: quay.mirrors.ustc.edu.cn/coreos/kube-state-metrics:v1.8.0                # kube-state-metrics:v1.9.7 适用于Kubernetes 1.16以上版本\r\n        imagePullPolicy: IfNotPresent\r\n        ports:\r\n        - containerPort: 8080\r\n      nodeSelector:\r\n        node-role.kubernetes.io/master: \"\"\r\n        kubernetes.io/hostname: \"master\"\r\n      tolerations:\r\n      - key: node-role.kubernetes.io/master\r\n        operator: Exists\r\n        effect: NoSchedule\n"})}),"\n",(0,a.jsx)(r.hr,{}),"\n",(0,a.jsxs)(r.h3,{id:"blackbox-exporter",children:[(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#blackbox-exporter",children:"#"}),"blackbox-exporter"]}),"\n",(0,a.jsx)(r.p,{children:"blackbox-exporter是一个黑盒探测工具，可以对服务的http、tcp、icmp等进行网络探测。"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"vim blackbox-exporter/config.yaml\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-yaml",meta:"",children:'apiVersion: v1\r\nkind: ConfigMap\r\nmetadata:\r\n  name: blackbox-exporter\r\n  namespace: monitoring\r\n  labels:\r\n    app: blackbox-exporter\r\ndata:\r\n  blackbox.yml: |-\r\n    modules:\r\n      http_2xx:\r\n        prober: http\r\n        timeout: 10s\r\n        http:\r\n          valid_http_versions: ["HTTP/1.1", "HTTP/2"]\r\n          valid_status_codes: []\r\n          method: GET\r\n          preferred_ip_protocol: "ip4"\r\n      http_post_2xx:\r\n        prober: http\r\n        timeout: 10s\r\n        http:\r\n          valid_http_versions: ["HTTP/1.1", "HTTP/2"]\r\n          method: POST\r\n          preferred_ip_protocol: "ip4"\r\n      tcp_connect:\r\n        prober: tcp\r\n        timeout: 10s\r\n      icmp:\r\n        prober: icmp\r\n        timeout: 10s\r\n        icmp:\r\n          preferred_ip_protocol: "ip4"\n'})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"vim blackbox-exporter/blackbox-exporter.yaml\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-yaml",meta:"",children:"apiVersion: v1\r\nkind: Service\r\nmetadata:\r\n  name: blackbox-exporter\r\n  namespace: monitoring\r\n  labels:\r\n    app: blackbox-exporter\r\n  annotations:\r\n    prometheus.io/scrape: 'true'\r\nspec:\r\n  selector:\r\n    app: blackbox-exporter\r\n  ports:\r\n  - name: blackbox\r\n    port: 9115\r\n    protocol: TCP\r\n    targetPort: 9115\r\n    nodePort: 30115\r\n  type: NodePort\r\n  \r\n---  \r\napiVersion: apps/v1\r\nkind: Deployment\r\nmetadata:\r\n  name: blackbox-exporter\r\n  namespace: monitoring\r\nspec:\r\n  replicas: 1\r\n  selector:\r\n    matchLabels:\r\n      app: blackbox-exporter\r\n  template:\r\n    metadata:\r\n      labels:\r\n        app: blackbox-exporter\r\n    spec:\r\n      containers:\r\n      - name: blackbox-exporter\r\n        image: prom/blackbox-exporter:latest\r\n        imagePullPolicy: IfNotPresent\r\n        ports:\r\n        - containerPort: 9115\r\n        readinessProbe:\r\n          tcpSocket:\r\n            port: 9115\r\n          initialDelaySeconds: 10\r\n          timeoutSeconds: 5\r\n        resources:\r\n          requests:\r\n            memory: 50Mi\r\n            cpu: 100m\r\n          limits:\r\n            memory: 60Mi\r\n            cpu: 200m\r\n        volumeMounts:\r\n        - name: config\r\n          mountPath: /etc/blackbox_exporter\r\n        args:\r\n        - '--config.file=/etc/blackbox_exporter/blackbox.yml'\r\n        - '--web.listen-address=:9115'\r\n      volumes:\r\n      - name: config\r\n        configMap:\r\n          name: blackbox-exporter\r\n      nodeSelector:\r\n        node-role.kubernetes.io/master: \"\"\r\n      tolerations:\r\n      - key: node-role.kubernetes.io/master\r\n        operator: Exists\r\n        effect: NoSchedule\r\n\n"})}),"\n",(0,a.jsxs)(r.blockquote,{children:["\n",(0,a.jsxs)(r.p,{children:["注意：\r\nblackbox-exporter的配置文件为 ",(0,a.jsx)(r.code,{children:"/etc/blackbox_exporter/blackbox.yml"}),"， 运行时可以动态重载配置文件，当重新加载配置文件失败时，不影响运行中的配置。"]}),"\n",(0,a.jsxs)(r.p,{children:["重载方式：",(0,a.jsx)(r.code,{children:"curl -XPOST http://ip:9115/-/reload"})]}),"\n"]}),"\n",(0,a.jsx)(r.hr,{}),"\n",(0,a.jsxs)(r.h3,{id:"dingtalk",children:[(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#dingtalk",children:"#"}),"dingtalk"]}),"\n",(0,a.jsx)(r.p,{children:"未验证！！"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"vim dingtalk/config.yaml\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-yaml",meta:"",children:"apiVersion: v1\r\nkind: ConfigMap\r\nmetadata:\r\n  name: dingtalk-config\r\n  namespace: monitoring\r\ndata:\r\n  config.yml: |-\r\n    targets:\r\n      webhook:\r\n        url: https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx             #修改为钉钉机器人的webhook\r\n        mention:\r\n          all: true             #@所有\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"vim dingtalk/dingtalk.yaml\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-yaml",meta:"",children:"apiVersion: v1\r\nkind: Service\r\nmetadata:\r\n  name: dingtalk\r\n  namespace: monitoring\r\n  labels:\r\n    app: dingtalk\r\n  annotations:\r\n    prometheus.io/scrape: 'false'\r\nspec:\r\n  selector:\r\n    app: dingtalk\r\n  ports:\r\n  - name: dingtalk\r\n    port: 8060\r\n    protocol: TCP\r\n    targetPort: 8060\r\n  \r\n---\r\napiVersion: apps/v1\r\nkind: Deployment\r\nmetadata:\r\n  name: dingtalk\r\n  namespace: monitoring\r\nspec:\r\n  replicas: 1\r\n  selector:\r\n    matchLabels:\r\n      app: dingtalk\r\n  template:\r\n    metadata:\r\n      name: dingtalk\r\n      labels:\r\n        app: dingtalk\r\n    spec:\r\n      containers:\r\n      - name: dingtalk\r\n        image: timonwong/prometheus-webhook-dingtalk:latest\r\n        imagePullPolicy: IfNotPresent\r\n        ports:\r\n        - containerPort: 8060\r\n        volumeMounts:\r\n        - name: config\r\n          mountPath: /etc/prometheus-webhook-dingtalk\r\n      volumes:\r\n      - name: config\r\n        configMap:\r\n          name: dingtalk-config\n"})}),"\n",(0,a.jsxs)(r.h3,{id:"alertmanager",children:[(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#alertmanager",children:"#"}),"alertmanager"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"vim alertmanager/templates.yaml\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-yaml",meta:"",children:'apiVersion: v1\r\nkind: ConfigMap\r\nmetadata:\r\n  name: alertmanager-templates\r\n  namespace: monitoring\r\ndata:\r\n  default.tmpl: |\r\n    {{ define "__alertmanager" }}AlertManager{{ end }}\r\n    {{ define "__alertmanagerURL" }}{{ .ExternalURL }}/#/alerts?receiver={{ .Receiver }}{{ end }}\r\n    {{ define "__subject" }}[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .GroupLabels.SortedPairs.Values | join " " }} {{ if gt (len .CommonLabels) (len .GroupLabels) }}({{ with .CommonLabels.Remove .GroupLabels.Names }}{{ .Values | join " " }}{{ end }}){{ end }}{{ end }}\r\n    {{ define "__description" }}{{ end }}\r\n    {{ define "__text_alert_list" }}{{ range . }}Labels:\r\n    {{ range .Labels.SortedPairs }} - {{ .Name }} = {{ .Value }}\r\n    {{ end }}Annotations:\r\n    {{ range .Annotations.SortedPairs }} - {{ .Name }} = {{ .Value }}\r\n    {{ end }}Source: {{ .GeneratorURL }}\r\n    {{ end }}{{ end }}\r\n    {{ define "slack.default.title" }}{{ template "__subject" . }}{{ end }}\r\n    {{ define "slack.default.username" }}{{ template "__alertmanager" . }}{{ end }}\r\n    {{ define "slack.default.fallback" }}{{ template "slack.default.title" . }} | {{ template "slack.default.titlelink" . }}{{ end }}\r\n    {{ define "slack.default.pretext" }}{{ end }}\r\n    {{ define "slack.default.titlelink" }}{{ template "__alertmanagerURL" . }}{{ end }}\r\n    {{ define "slack.default.iconemoji" }}{{ end }}\r\n    {{ define "slack.default.iconurl" }}{{ end }}\r\n    {{ define "slack.default.text" }}{{ end }}\r\n    {{ define "hipchat.default.from" }}{{ template "__alertmanager" . }}{{ end }}\r\n    {{ define "hipchat.default.message" }}{{ template "__subject" . }}{{ end }}\r\n    {{ define "pagerduty.default.description" }}{{ template "__subject" . }}{{ end }}\r\n    {{ define "pagerduty.default.client" }}{{ template "__alertmanager" . }}{{ end }}\r\n    {{ define "pagerduty.default.clientURL" }}{{ template "__alertmanagerURL" . }}{{ end }}\r\n    {{ define "pagerduty.default.instances" }}{{ template "__text_alert_list" . }}{{ end }}\r\n    {{ define "opsgenie.default.message" }}{{ template "__subject" . }}{{ end }}\r\n    {{ define "opsgenie.default.description" }}{{ .CommonAnnotations.SortedPairs.Values | join " " }}\r\n    {{ if gt (len .Alerts.Firing) 0 -}}\r\n    Alerts Firing:\r\n    {{ template "__text_alert_list" .Alerts.Firing }}\r\n    {{- end }}\r\n    {{ if gt (len .Alerts.Resolved) 0 -}}\r\n    Alerts Resolved:\r\n    {{ template "__text_alert_list" .Alerts.Resolved }}\r\n    {{- end }}\r\n    {{- end }}\r\n    {{ define "opsgenie.default.source" }}{{ template "__alertmanagerURL" . }}{{ end }}\r\n    {{ define "victorops.default.message" }}{{ template "__subject" . }} | {{ template "__alertmanagerURL" . }}{{ end }}\r\n    {{ define "victorops.default.from" }}{{ template "__alertmanager" . }}{{ end }}\r\n    {{ define "email.default.subject" }}{{ template "__subject" . }}{{ end }}\r\n    {{ define "email.default.html" }}\r\n    <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">\r\n    \x3c!--\r\n    Style and HTML derived from https://github.com/mailgun/transactional-email-templates\r\n    The MIT License (MIT)\r\n    Copyright (c) 2014 Mailgun\r\n    Permission is hereby granted, free of charge, to any person obtaining a copy\r\n    of this software and associated documentation files (the "Software"), to deal\r\n    in the Software without restriction, including without limitation the rights\r\n    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\r\n    copies of the Software, and to permit persons to whom the Software is\r\n    furnished to do so, subject to the following conditions:\r\n    The above copyright notice and this permission notice shall be included in all\r\n    copies or substantial portions of the Software.\r\n    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\n    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\r\n    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\r\n    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\r\n    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\r\n    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\r\n    SOFTWARE.\r\n    --\x3e\r\n    <html xmlns="http://www.w3.org/1999/xhtml" xmlns="http://www.w3.org/1999/xhtml" style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">\r\n    <head style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">\r\n    <meta name="viewport" content="width=device-width" style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />\r\n    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />\r\n    <title style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">{{ template "__subject" . }}</title>\r\n    </head>\r\n    <body itemscope="" itemtype="http://schema.org/EmailMessage" style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; -webkit-font-smoothing: antialiased; -webkit-text-size-adjust: none; height: 100%; line-height: 1.6em; width: 100% !important; background-color: #f6f6f6; margin: 0; padding: 0;" bgcolor="#f6f6f6">\r\n    <table style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; width: 100%; background-color: #f6f6f6; margin: 0;" bgcolor="#f6f6f6">\r\n      <tr style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">\r\n        <td style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0;" valign="top"></td>\r\n        <td width="600" style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; display: block !important; max-width: 600px !important; clear: both !important; width: 100% !important; margin: 0 auto; padding: 0;" valign="top">\r\n          <div style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; max-width: 600px; display: block; margin: 0 auto; padding: 0;">\r\n            <table width="100%" cellpadding="0" cellspacing="0" style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; border-radius: 3px; background-color: #fff; margin: 0; border: 1px solid #e9e9e9;" bgcolor="#fff">\r\n              <tr style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">\r\n                <td style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 16px; vertical-align: top; color: #fff; font-weight: 500; text-align: center; border-radius: 3px 3px 0 0; background-color: #E6522C; margin: 0; padding: 20px;" align="center" bgcolor="#E6522C" valign="top">\r\n                  {{ .Alerts | len }} alert{{ if gt (len .Alerts) 1 }}s{{ end }} for {{ range .GroupLabels.SortedPairs }}\r\n                    {{ .Name }}={{ .Value }}\r\n                  {{ end }}\r\n                </td>\r\n              </tr>\r\n              <tr style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">\r\n                <td style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 10px;" valign="top">\r\n                  <table width="100%" cellpadding="0" cellspacing="0" style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">\r\n                    <tr style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">\r\n                      <td style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 0 0 20px;" valign="top">\r\n                        <a href="{{ template "__alertmanagerURL" . }}" style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; color: #FFF; text-decoration: none; line-height: 2em; font-weight: bold; text-align: center; cursor: pointer; display: inline-block; border-radius: 5px; text-transform: capitalize; background-color: #348eda; margin: 0; border-color: #348eda; border-style: solid; border-width: 10px 20px;">View in {{ template "__alertmanager" . }}</a>\r\n                      </td>\r\n                    </tr>\r\n                    {{ if gt (len .Alerts.Firing) 0 }}\r\n                    <tr style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">\r\n                      <td style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 0 0 20px;" valign="top">\r\n                        <strong style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">[{{ .Alerts.Firing | len }}] Firing</strong>\r\n                      </td>\r\n                    </tr>\r\n                    {{ end }}\r\n                    {{ range .Alerts.Firing }}\r\n                    <tr style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">\r\n                      <td style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 0 0 20px;" valign="top">\r\n                        <strong style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">Labels</strong><br style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />\r\n                        {{ range .Labels.SortedPairs }}{{ .Name }} = {{ .Value }}<br style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />{{ end }}\r\n                        {{ if gt (len .Annotations) 0 }}<strong style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">Annotations</strong><br style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />{{ end }}\r\n                        {{ range .Annotations.SortedPairs }}{{ .Name }} = {{ .Value }}<br style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />{{ end }}\r\n                        <a href="{{ .GeneratorURL }}" style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; color: #348eda; text-decoration: underline; margin: 0;">Source</a><br style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />\r\n                      </td>\r\n                    </tr>\r\n                    {{ end }}\r\n                    {{ if gt (len .Alerts.Resolved) 0 }}\r\n                      {{ if gt (len .Alerts.Firing) 0 }}\r\n                    <tr style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">\r\n                      <td style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 0 0 20px;" valign="top">\r\n                        <br style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />\r\n                        <hr style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />\r\n                        <br style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />\r\n                      </td>\r\n                    </tr>\r\n                      {{ end }}\r\n                    <tr style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">\r\n                      <td style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 0 0 20px;" valign="top">\r\n                        <strong style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">[{{ .Alerts.Resolved | len }}] Resolved</strong>\r\n                      </td>\r\n                    </tr>\r\n                    {{ end }}\r\n                    {{ range .Alerts.Resolved }}\r\n                    <tr style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">\r\n                      <td style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 0 0 20px;" valign="top">\r\n                        <strong style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">Labels</strong><br style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />\r\n                        {{ range .Labels.SortedPairs }}{{ .Name }} = {{ .Value }}<br style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />{{ end }}\r\n                        {{ if gt (len .Annotations) 0 }}<strong style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">Annotations</strong><br style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />{{ end }}\r\n                        {{ range .Annotations.SortedPairs }}{{ .Name }} = {{ .Value }}<br style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />{{ end }}\r\n                        <a href="{{ .GeneratorURL }}" style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; color: #348eda; text-decoration: underline; margin: 0;">Source</a><br style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;" />\r\n                      </td>\r\n                    </tr>\r\n                    {{ end }}\r\n                  </table>\r\n                </td>\r\n              </tr>\r\n            </table>\r\n            <div style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; width: 100%; clear: both; color: #999; margin: 0; padding: 20px;">\r\n              <table width="100%" style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">\r\n                <tr style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;">\r\n                  <td style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 12px; vertical-align: top; text-align: center; color: #999; margin: 0; padding: 0 0 20px;" align="center" valign="top"><a href="{{ .ExternalURL }}" style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 12px; color: #999; text-decoration: underline; margin: 0;">Sent by {{ template "__alertmanager" . }}</a></td>\r\n                </tr>\r\n              </table>\r\n            </div></div>\r\n        </td>\r\n        <td style="font-family: \'Helvetica Neue\', Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0;" valign="top"></td>\r\n      </tr>\r\n    </table>\r\n    </body>\r\n    </html>\r\n    {{ end }}\r\n    {{ define "pushover.default.title" }}{{ template "__subject" . }}{{ end }}\r\n    {{ define "pushover.default.message" }}{{ .CommonAnnotations.SortedPairs.Values | join " " }}\r\n    {{ if gt (len .Alerts.Firing) 0 }}\r\n    Alerts Firing:\r\n    {{ template "__text_alert_list" .Alerts.Firing }}\r\n    {{ end }}\r\n    {{ if gt (len .Alerts.Resolved) 0 }}\r\n    Alerts Resolved:\r\n    {{ template "__text_alert_list" .Alerts.Resolved }}\r\n    {{ end }}\r\n    {{ end }}\r\n    {{ define "pushover.default.url" }}{{ template "__alertmanagerURL" . }}{{ end }}\r\n  slack.tmpl: |\r\n    {{ define "slack.devops.text" }}\r\n    {{range .Alerts}}{{.Annotations.DESCRIPTION}}\r\n    {{end}}\r\n    {{ end }}\n'})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"vim alertmanager/config.yaml\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-yaml",meta:"",children:"apiVersion: v1\r\nkind: ConfigMap\r\nmetadata:\r\n  name: alertmanager-config\r\n  namespace: monitoring\r\ndata:\r\n  config.yml: |-\r\n    global:\r\n      resolve_timeout: 5m\r\n      smtp_smarthost: 'smtp.163.com:465'                #邮箱smtp服务器代理，启用SSL发信, 端口一般是465\r\n      smtp_from: 'alert@163.com'                #发送邮箱名称\r\n      smtp_auth_username: 'alert@163.com'               #邮箱名称\r\n      smtp_auth_password: 'password'                #邮箱密码或授权码\r\n      smtp_require_tls: false\r\n    templates:\r\n    - '/etc/templates/*.tmpl'\r\n    route:\r\n      receiver: 'default'\r\n      group_wait: 10s\r\n      group_interval: 1m\r\n      repeat_interval: 1h\r\n      group_by: ['alertname', 'instance', 'cluster', 'service']\r\n      routes:\r\n      - receiver: 'default'\r\n        match:\r\n          severity: 'warning'\r\n      - receiver: 'dingtalk'\r\n        match:\r\n          severity: 'critical'\r\n    inhibit_rules:\r\n    - source_match:\r\n        severity: 'critical'\r\n      target_match:\r\n        severity: 'warning'\r\n      equal: ['alertname', 'instance', 'cluster', 'service']\r\n    receivers:\r\n    - name: 'default'\r\n      email_configs:\r\n      - to: 'receiver@163.com'\r\n        send_resolved: true\r\n    - name: 'dingtalk'\r\n      webhook_configs:\r\n      - url: 'http://dingtalk:8060/dingtalk/webhook/send'\r\n        send_resolved: true\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"vim alertmanager/alertmanager.yaml\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-yaml",meta:"",children:'apiVersion: v1\r\nkind: Service\r\nmetadata:\r\n  name: alertmanager\r\n  namespace: monitoring\r\n  labels:\r\n    name: alertmanager\r\n  annotations:\r\n    prometheus.io/scrape: \'true\'\r\nspec:\r\n  selector:\r\n    app: alertmanager\r\n  ports:\r\n  - name: alertmanager\r\n    port: 9093\r\n    protocol: TCP\r\n    targetPort: 9093\r\n  type: NodePort \r\n---\r\napiVersion: apps/v1\r\nkind: Deployment\r\nmetadata:\r\n  name: alertmanager\r\n  namespace: monitoring\r\nspec:\r\n  replicas: 1\r\n  selector:\r\n    matchLabels:\r\n      app: alertmanager\r\n  template:\r\n    metadata:\r\n      name: alertmanager\r\n      labels:\r\n        app: alertmanager\r\n    spec:\r\n      containers:\r\n      - name: alertmanager\r\n        image: prom/alertmanager:latest\r\n        imagePullPolicy: IfNotPresent\r\n        ports:\r\n        - containerPort: 9093\r\n        env:\r\n        - name: POD_IP\r\n          valueFrom:\r\n            fieldRef:\r\n              apiVersion: v1\r\n              fieldPath: status.podIP\r\n        args:\r\n          - "--config.file=/etc/alertmanager/config.yml"\r\n          - "--storage.path=/alertmanager"\r\n          - "--cluster.advertise-address=$(POD_IP):6783"                #没有该参数会报错：Failed to get final advertise address\r\n        volumeMounts:\r\n        - name: config\r\n          mountPath: /etc/alertmanager\r\n        - name: templates\r\n          mountPath: /etc/templates\r\n        - name: alertmanager\r\n          mountPath: /alertmanager\r\n      volumes:\r\n      - name: config\r\n        configMap:\r\n          name: alertmanager-config\r\n      - name: templates\r\n        configMap:\r\n          name: alertmanager-templates\r\n      - name: alertmanager\r\n        emptyDir: {}\n'})}),"\n",(0,a.jsx)(r.hr,{}),"\n",(0,a.jsxs)(r.h3,{id:"prometheus",children:[(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#prometheus",children:"#"}),"prometheus"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"vim prometheus/rbac.yaml\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-yaml",meta:"",children:"---         \r\napiVersion: v1\r\nkind: Service\r\nmetadata:\r\n  name: prometheus\r\n  namespace: monitoring\r\n  labels:\r\n    app: prometheus\r\n  annotations:\r\n    prometheus.io/scrape: 'true'\r\nspec:\r\n  selector:\r\n    app: prometheus\r\n  ports:\r\n  - name: prometheus\r\n    port: 9090\r\n    protocol: TCP\r\n    targetPort: 9090\r\n  type: NodePort\r\n          \r\n---\r\napiVersion: apps/v1\r\nkind: Deployment\r\nmetadata:\r\n  name: prometheus\r\n  namespace: monitoring\r\n  labels:\r\n    app: prometheus\r\nspec:\r\n  replicas: 1\r\n  selector:\r\n    matchLabels:\r\n      app: prometheus\r\n  template:\r\n    metadata:\r\n      name: prometheus\r\n      labels:\r\n        app: prometheus\r\n    spec:\r\n      serviceAccountName: prometheus\r\n      containers:\r\n      - name: prometheus\r\n        image: prom/prometheus:latest\r\n        imagePullPolicy: IfNotPresent\r\n        args:\r\n          - '--storage.tsdb.path=/prometheus'\r\n          - '--storage.tsdb.retention.time=30d'\r\n          - '--config.file=/etc/prometheus/prometheus.yml'\r\n        ports:\r\n        - containerPort: 9090\r\n        resources:\r\n          requests:\r\n            cpu: 500m\r\n            memory: 500M\r\n          limits:\r\n            cpu: 500m\r\n            memory: 500M\r\n        volumeMounts:\r\n        - name: config\r\n          mountPath: /etc/prometheus\r\n        - name: rules\r\n          mountPath: /etc/prometheus-rules\r\n        - name: prometheus\r\n          mountPath: /prometheus\r\n      volumes:\r\n      - name: config\r\n        configMap:\r\n          name: prometheus-config\r\n      - name: rules\r\n        configMap:\r\n          name: prometheus-rules\r\n      - name: prometheus\r\n        emptyDir: {}\r\n      nodeSelector:\r\n        node-role.kubernetes.io/master: \"\"\r\n        kubernetes.io/hostname: \"master\"\r\n      tolerations:\r\n      - key: node-role.kubernetes.io/master\r\n        operator: Exists\r\n        effect: NoSchedule\r\n\n"})}),"\n",(0,a.jsx)(r.p,{children:"==prometheus配置文件说明：=="}),"\n",(0,a.jsxs)(r.blockquote,{children:["\n",(0,a.jsx)(r.p,{children:"annotations将任何非标识metadata附加到对象，而labels可用于选择对象并查找满足某些条件的对象集合。相比之下，annotations不用于标识和选择对象，虽然它也是键值形式。annotations不会被Kubernetes直接使用，其主要目的是方便用户阅读查找。"}),"\n",(0,a.jsxs)(r.p,{children:["Kubernetes的API SERVER会暴露API服务，Promethues集成了对Kubernetes的自动发现，它有5种模式：node、service、pod、endpoints、ingress。 上面是Prometheus官方给出的对Kubernetes服务发现的配置。可以看到大量的relabel_configs，其实把所有的relabel_configs去掉一样可以对kubernetes做服务发现。 relabel_configs仅仅是对采集过来的指标做二次处理，比如要什么、不要什么以及替换什么等等。而以 _",(0,a.jsx)(r.em,{children:"meta"})," 开头的这些元数据标签都是实例中包含的， 而relabel则是动态的修改、覆盖、添加删除这些标签或者这些标签对应的值。而且以 __ 开头的标签通常是系统内部使用的，因此这些标签不会被写入样本数据中， 如果我们要收集这些东西那么则要进行relabel操作。当然relabel操作也不仅限于操作以 __ 开头的标签。"]}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.strong,{children:"action的行为："})}),"\n",(0,a.jsx)(r.p,{children:"----\x3ereplace：默认行为，不配置action的话就采用这种行为，它会根据regex来去匹配source_labels标签上的值，并将并将匹配到的值写入target_label中;"}),"\n",(0,a.jsx)(r.p,{children:"----\x3elabelmap：它会根据regex去匹配标签名称，并将匹配到的内容作为新标签的名称，其值作为新标签的值;"}),"\n",(0,a.jsx)(r.p,{children:"----\x3ekeep：仅收集匹配到regex的源标签，而会丢弃没有匹配到的所有标签，用于选择;"}),"\n",(0,a.jsx)(r.p,{children:"----\x3edrop：丢弃匹配到regex的源标签，而会收集没有匹配到的所有标签，用于排除;"}),"\n",(0,a.jsx)(r.p,{children:"----\x3elabeldrop：使用regex匹配标签，符合regex规则的标签将从target实例中移除，其实也就是不收集不保存;"}),"\n",(0,a.jsx)(r.p,{children:"----\x3eabelkeep：使用regex匹配标签，仅收集符合regex规则的标签，不符合的不收集。"}),"\n"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"vim prometheus/config.yaml\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-yaml",meta:"",children:"apiVersion: v1\r\nkind: ConfigMap\r\nmetadata:\r\n  name: prometheus-config\r\n  namespace: monitoring\r\ndata:\r\n  prometheus.yml: |\r\n    global:\r\n      scrape_interval: 10s\r\n      scrape_timeout: 10s\r\n      evaluation_interval: 10s\r\n    alerting:\r\n      alertmanagers:\r\n      - static_configs:\r\n        - targets:\r\n          - alertmanager:9093\r\n    rule_files:\r\n      - \"/etc/prometheus-rules/*.rules\"\r\n    scrape_configs:\r\n      - job_name: 'node-exporter'                #node节点性能指标数据\r\n        tls_config:\r\n          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\r\n        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\r\n        kubernetes_sd_configs:\r\n        - role: endpoints\r\n        relabel_configs:\r\n        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_endpoint_port_name]\r\n          regex: true;node-exporter\r\n          action: keep\r\n        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]\r\n          action: replace\r\n          target_label: __scheme__\r\n          regex: (https?)\r\n        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]\r\n          action: replace\r\n          target_label: __metrics_path__\r\n          regex: (.+)\r\n        - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]\r\n          action: replace\r\n          target_label: __address__\r\n          regex: (.+)(?::\\d+);(\\d+)\r\n          replacement: $1:$2\r\n        - action: labelmap\r\n          regex: __meta_kubernetes_service_label_(.+)\r\n        - source_labels: [__meta_kubernetes_namespace]\r\n          action: replace\r\n          target_label: kubernetes_namespace\r\n        - source_labels: [__meta_kubernetes_service_name]\r\n          action: replace\r\n          target_label: kubernetes_name\r\n\r\n      - job_name: 'k8s-nodes'\r\n        scheme: https\r\n        tls_config:\r\n          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\r\n        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\r\n        kubernetes_sd_configs:\r\n        - role: node\r\n        relabel_configs:\r\n        - action: labelmap\r\n          regex: __meta_kubernetes_node_label_(.+)\r\n        - target_label: __address__\r\n          replacement: 10.1.93.190:6443\r\n        - source_labels: [__meta_kubernetes_node_name]\r\n          regex: (.+)\r\n          target_label: __metrics_path__\r\n          replacement: /api/v1/nodes/${1}/proxy/metrics\r\n\r\n      - job_name: 'kubernetes-cadvisor'                #容器、Pod相关的性能指标数据\r\n        scheme: https\r\n        tls_config:\r\n          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\r\n        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\r\n        kubernetes_sd_configs:\r\n        - role: node\r\n        relabel_configs:\r\n        - action: labelmap\r\n          regex: __meta_kubernetes_node_label_(.+)\r\n        - target_label: __address__\r\n          replacement: 10.1.93.190:6443\r\n        - source_labels: [__meta_kubernetes_node_name]\r\n          regex: (.+)\r\n          target_label: __metrics_path__\r\n          replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor\r\n        metric_relabel_configs:\r\n        - source_labels: [id]\r\n          action: replace\r\n          regex: '^/machine\\.slice/machine-rkt\\\\x2d([^\\\\]+)\\\\.+/([^/]+)\\.service$'\r\n          target_label: rkt_container_name\r\n          replacement: '${2}-${1}'\r\n        - source_labels: [id]\r\n          action: replace\r\n          regex: '^/system\\.slice/(.+)\\.service$'\r\n          target_label: systemd_service_name\r\n          replacement: '${1}'\r\n\r\n      - job_name: 'kube-state-metrics'              #资源对象(Deployment、Pod等)的状态\r\n        tls_config:\r\n          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\r\n        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\r\n        kubernetes_sd_configs:\r\n        - role: endpoints\r\n        relabel_configs:\r\n        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_endpoint_port_name]\r\n          regex: true;kube-state-metrics\r\n          action: keep\r\n        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]\r\n          action: replace\r\n          target_label: __scheme__\r\n          regex: (https?)\r\n        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]\r\n          action: replace\r\n          target_label: __metrics_path__\r\n          regex: (.+)\r\n        - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]\r\n          action: replace\r\n          target_label: __address__\r\n          regex: (.+)(?::\\d+);(\\d+)\r\n          replacement: $1:$2\r\n        - action: labelmap\r\n          regex: __meta_kubernetes_service_label_(.+)\r\n        - source_labels: [__meta_kubernetes_namespace]\r\n          action: replace\r\n          target_label: kubernetes_namespace\r\n        - source_labels: [__meta_kubernetes_service_name]\r\n          action: replace\r\n          target_label: kubernetes_name\r\n\r\n      - job_name: 'kubernetes-service-http-probe'               #通过http方式探测Service状态\r\n        tls_config:\r\n          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\r\n        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\r\n        kubernetes_sd_configs:\r\n        - role: service\r\n        metrics_path: /probe\r\n        params:\r\n          module: [http_2xx]\r\n        relabel_configs:\r\n        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_service_annotation_prometheus_io_http_probe]\r\n          regex: true;true\r\n          action: keep\r\n        - source_labels: [__meta_kubernetes_service_name, __meta_kubernetes_namespace, __meta_kubernetes_service_annotation_prometheus_io_http_probe_port, __meta_kubernetes_service_annotation_prometheus_io_http_probe_path]\r\n          action: replace\r\n          target_label: __param_target\r\n          regex: (.+);(.+);(.+);(.+)\r\n          replacement: $1.$2:$3$4\r\n        - target_label: __address__\r\n          replacement: 10.1.93.190:30115\r\n        - source_labels: [__param_target]\r\n          target_label: instance\r\n        - action: labelmap\r\n          regex: __meta_kubernetes_service_annotation_prometheus_io_app_info_(.+)\r\n\r\n      - job_name: 'kubernetes-service-tcp-probe'                #通过tcp方式探测Service状态\r\n        tls_config:\r\n          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\r\n        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token\r\n        kubernetes_sd_configs:\r\n        - role: service\r\n        metrics_path: /probe\r\n        params:\r\n          module: [tcp_connect]\r\n        relabel_configs:\r\n        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_service_annotation_prometheus_io_tcp_probe]\r\n          regex: true;true\r\n          action: keep\r\n        - source_labels: [__meta_kubernetes_service_name, __meta_kubernetes_namespace, __meta_kubernetes_service_annotation_prometheus_io_tcp_probe_port]\r\n          action: replace\r\n          target_label: __param_target\r\n          regex: (.+);(.+);(.+)\r\n          replacement: $1.$2:$3\r\n        - target_label: __address__\r\n          replacement: 10.1.93.190:30115\r\n        - source_labels: [__param_target]\r\n          target_label: instance\r\n        - action: labelmap\r\n          regex: __meta_kubernetes_service_annotation_prometheus_io_app_info_(.+)\r\n\r\n      - job_name: 'kubernetes-ingresses'              #通过http方式探测ingresses状态\r\n        kubernetes_sd_configs:\r\n        - role: ingress\r\n        metrics_path: /probe\r\n        params:\r\n          module: [http_2xx]\r\n        relabel_configs:\r\n        - source_labels: [__meta_kubernetes_ingress_scheme, __address__, __meta_kubernetes_ingress_path]\r\n          regex: (.+);(.+);(.+)\r\n          replacement: ${1}://${2}${3}\r\n          target_label: __param_target\r\n        - target_label: __address__\r\n          replacement: 10.1.93.190:30115\r\n        - source_labels: [__param_target]\r\n          target_label: instance\r\n        - action: labelmap\r\n          regex: __meta_kubernetes_ingress_label_(.+)\r\n        - source_labels: [__meta_kubernetes_namespace]\r\n          target_label: kubernetes_namespace\r\n        - source_labels: [__meta_kubernetes_ingress_name]\r\n          target_label: kubernetes_name\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"vim prometheus/rules.yaml\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-yaml",meta:"",children:'apiVersion: v1\r\nkind: ConfigMap\r\nmetadata:\r\n  name: prometheus-rules\r\n  namespace: monitoring\r\ndata:\r\n  node.rules: |\r\n    groups:\r\n    - name: node\r\n      rules:\r\n      - alert: NodeDown\r\n        expr: up == 0\r\n        for: 3m\r\n        labels:\r\n          severity: critical\r\n        annotations:\r\n          summary: "{{ $labels.instance }}: down"\r\n          description: "{{ $labels.instance }} has been down for more than 3m"\r\n          value: "{{ $value }}"\r\n      - alert: NodeCPUHigh\r\n        expr: (1 - avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m]))) * 100 > 75\r\n        for: 5m\r\n        labels:\r\n          severity: warning\r\n        annotations:\r\n          summary: "{{$labels.instance}}: High CPU usage"\r\n          description: "{{$labels.instance}}: CPU usage is above 75%"\r\n          value: "{{ $value }}"\r\n \r\n      - alert: NodeCPUIowaitHigh\r\n        expr: avg by (instance) (irate(node_cpu_seconds_total{mode="iowait"}[5m])) * 100 > 50\r\n        for: 5m\r\n        labels:\r\n          severity: warning\r\n        annotations:\r\n          summary: "{{$labels.instance}}: High CPU iowait usage"\r\n          description: "{{$labels.instance}}: CPU iowait usage is above 50%"\r\n          value: "{{ $value }}"\r\n \r\n      - alert: NodeMemoryUsageHigh\r\n        expr: (1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100 > 90\r\n        for: 5m\r\n        labels:\r\n          severity: warning\r\n        annotations:\r\n          summary: "{{$labels.instance}}: High memory usage"\r\n          description: "{{$labels.instance}}: Memory usage is above 90%"\r\n          value: "{{ $value }}"\r\n \r\n      - alert: NodeDiskRootLow\r\n        expr: (1 - node_filesystem_avail_bytes{fstype=~"ext.*|xfs",mountpoint ="/"} / node_filesystem_size_bytes{fstype=~"ext.*|xfs",mountpoint ="/"}) * 100 > 80\r\n        for: 10m\r\n        labels:\r\n          severity: warning\r\n        annotations:\r\n          summary: "{{$labels.instance}}: Low disk(the / partition) space"\r\n          description: "{{$labels.instance}}: Disk(the / partition) usage is above 80%"\r\n          value: "{{ $value }}"\r\n        \r\n      - alert: NodeDiskBootLow\r\n        expr: (1 - node_filesystem_avail_bytes{fstype=~"ext.*|xfs",mountpoint ="/boot"} / node_filesystem_size_bytes{fstype=~"ext.*|xfs",mountpoint ="/boot"}) * 100 > 80\r\n        for: 10m\r\n        labels:\r\n          severity: warning\r\n        annotations:\r\n          summary: "{{$labels.instance}}: Low disk(the /boot partition) space"\r\n          description: "{{$labels.instance}}: Disk(the /boot partition) usage is above 80%"\r\n          value: "{{ $value }}"\r\n \r\n      - alert: NodeLoad5High\r\n        expr: (node_load5) > (count by (instance) (node_cpu_seconds_total{mode=\'system\'}) * 2)\r\n        for: 5m\r\n        labels:\r\n          severity: warning\r\n        annotations:\r\n          summary: "{{$labels.instance}}: Load(5m) High"\r\n          description: "{{$labels.instance}}: Load(5m) is 2 times the number of CPU cores"\r\n          value: "{{ $value }}"\n'})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"vim prometheus/prometheus.yaml\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-yaml",meta:"",children:"---         \r\napiVersion: v1\r\nkind: Service\r\nmetadata:\r\n  name: prometheus\r\n  namespace: monitoring\r\n  labels:\r\n    app: prometheus\r\n  annotations:\r\n    prometheus.io/scrape: 'true'\r\nspec:\r\n  selector:\r\n    app: prometheus\r\n  ports:\r\n  - name: prometheus\r\n    port: 9090\r\n    protocol: TCP\r\n    targetPort: 9090\r\n  type: NodePort\r\n          \r\n---\r\napiVersion: apps/v1\r\nkind: Deployment\r\nmetadata:\r\n  name: prometheus\r\n  namespace: monitoring\r\n  labels:\r\n    app: prometheus\r\nspec:\r\n  replicas: 1\r\n  selector:\r\n    matchLabels:\r\n      app: prometheus\r\n  template:\r\n    metadata:\r\n      name: prometheus\r\n      labels:\r\n        app: prometheus\r\n    spec:\r\n      serviceAccountName: prometheus\r\n      containers:\r\n      - name: prometheus\r\n        image: prom/prometheus:latest\r\n        imagePullPolicy: IfNotPresent\r\n        args:\r\n          - '--storage.tsdb.path=/prometheus'\r\n          - '--storage.tsdb.retention.time=30d'\r\n          - '--config.file=/etc/prometheus/prometheus.yml'\r\n        ports:\r\n        - containerPort: 9090\r\n        resources:\r\n          requests:\r\n            cpu: 500m\r\n            memory: 500M\r\n          limits:\r\n            cpu: 500m\r\n            memory: 500M\r\n        volumeMounts:\r\n        - name: config\r\n          mountPath: /etc/prometheus\r\n        - name: rules\r\n          mountPath: /etc/prometheus-rules\r\n        - name: prometheus\r\n          mountPath: /prometheus\r\n      volumes:\r\n      - name: config\r\n        configMap:\r\n          name: prometheus-config\r\n      - name: rules\r\n        configMap:\r\n          name: prometheus-rules\r\n      - name: prometheus\r\n        emptyDir: {}\r\n      nodeSelector:\r\n        node-role.kubernetes.io/master: \"\"\r\n        kubernetes.io/hostname: \"master\"\r\n      tolerations:\r\n      - key: node-role.kubernetes.io/master\r\n        operator: Exists\r\n        effect: NoSchedule\n"})}),"\n",(0,a.jsx)(r.hr,{}),"\n",(0,a.jsxs)(r.h3,{id:"grafana",children:[(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#grafana",children:"#"}),"grafana"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"vim grafana/secret.yaml\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-yaml",meta:"",children:"apiVersion: v1\r\nkind: Secret\r\nmetadata:\r\n  name: grafana\r\n  namespace: monitoring\r\ndata:\r\n  admin-password: YWRtaW4=              # base64 加解密\r\n  admin-username: YWRtaW4=\r\ntype: Opaque\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"vim grafana/grafana.yaml\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-yaml",meta:"",children:'---\r\napiVersion: v1\r\nkind: Service\r\nmetadata:\r\n  name: grafana\r\n  namespace: monitoring\r\n  labels:\r\n    app: grafana\r\n  annotations:\r\n    prometheus.io/scrape: \'true\'\r\n    prometheus.io/path: \'/metrics\'\r\nspec:\r\n  selector:\r\n    app: grafana\r\n  ports:\r\n  - name: grafana\r\n    port: 3000\r\n    protocol: TCP\r\n    targetPort: 3000\r\n  type: NodePort\r\n---\r\napiVersion: apps/v1\r\nkind: Deployment\r\nmetadata:\r\n  name: grafana\r\n  namespace: monitoring\r\n  labels:\r\n    app: grafana\r\nspec:\r\n  replicas: 1\r\n  selector:\r\n    matchLabels:\r\n      app: grafana\r\n  template:\r\n    metadata:\r\n      labels:\r\n        app: grafana\r\n    spec:\r\n      containers:\r\n      - name: grafana\r\n        image: grafana/grafana:latest\r\n        imagePullPolicy: IfNotPresent\r\n        ports:\r\n        - containerPort: 3000\r\n          name: grafana\r\n        resources:\r\n          limits:\r\n            cpu: 100m\r\n            memory: 100Mi\r\n          requests:\r\n            cpu: 100m\r\n            memory: 100Mi\r\n        env:\r\n          - name: GF_AUTH_BASIC_ENABLED\r\n            value: "true"\r\n          - name: GF_AUTH_ANONYMOUS_ENABLED\r\n            value: "false"\r\n          - name: GF_AUTH_ANONYMOUS_ORG_ROLE\r\n            value: Admin\r\n          - name: GF_DASHBOARDS_JSON_ENABLED\r\n            value: "true"\r\n          - name: GF_INSTALL_PLUGINS\r\n            value: grafana-kubernetes-app               #安装grafana-kubernetes-app插件\r\n          - name: GF_SECURITY_ADMIN_USER\r\n            valueFrom:\r\n              secretKeyRef:\r\n                name: grafana\r\n                key: admin-username\r\n          - name: GF_SECURITY_ADMIN_PASSWORD\r\n            valueFrom:\r\n              secretKeyRef:\r\n                name: grafana\r\n                key: admin-password\r\n        readinessProbe:\r\n          httpGet:\r\n            path: /login\r\n            port: 3000\r\n          initialDelaySeconds: 10\r\n          timeoutSeconds: 5\r\n        volumeMounts:\r\n        - name: grafana-storage\r\n          mountPath: /var/lib/grafana\r\n      volumes:\r\n      - name: grafana-storage\r\n        emptyDir: {}\r\n\n'})}),"\n",(0,a.jsx)(r.hr,{}),"\n",(0,a.jsxs)(r.h3,{id:"部署",children:[(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#部署",children:"#"}),"部署"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"# 文件目录结构\r\n[root@master prometheus2]# tree\r\n.\r\n├── alertmanager\r\n│\xa0\xa0 ├── alertmanager.yaml\r\n│\xa0\xa0 ├── config.yaml\r\n│\xa0\xa0 └── templates.yaml\r\n├── blackbox-exporter\r\n│\xa0\xa0 ├── blackbox-exporter.yaml\r\n│\xa0\xa0 └── config.yaml\r\n├── dingtalk\r\n│\xa0\xa0 ├── config.yaml\r\n│\xa0\xa0 └── dingtalk.yaml\r\n├── grafana\r\n│\xa0\xa0 ├── grafana.yaml\r\n│\xa0\xa0 └── secret.yaml\r\n├── k8s\r\n│\xa0\xa0 ├── kube-controller-manager-prometheus-discovery.yaml\r\n│\xa0\xa0 ├── kube-proxy-prometheus-discovery.yaml\r\n│\xa0\xa0 └── kube-scheduler-prometheus-discovery.yaml\r\n├── kube-state-metrics\r\n│\xa0\xa0 ├── kube-state-metrics.yaml\r\n│\xa0\xa0 └── rbac.yaml\r\n├── node-exporter\r\n│\xa0\xa0 └── node-exporter.yaml\r\n└── prometheus\r\n    ├── config.yaml\r\n    ├── nc.yaml\r\n    ├── prometheus.yaml\r\n    ├── rbac.yaml\r\n    └── rules.yaml\r\n\r\n8 directories, 20 files\r\n\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"# 部署\r\nkubectl apply -f namespace.yaml\r\n \r\nkubectl apply -f node-exporter/\r\n \r\nkubectl apply -f k8s/\r\n \r\nkubectl apply -f kube-state-metrics/\r\n \r\nkubectl apply -f blackbox-exporter/\r\n \r\nkubectl apply -f dingtalk/\r\n \r\nkubectl apply -f alertmanager/\r\n \r\nkubectl apply -f prometheus/\r\n \r\nkubectl apply -f grafana/\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"# 查看部署结果\r\n[root@master prometheus2]# kubectl get all -n monitoring\r\nNAME                                      READY   STATUS    RESTARTS   AGE\r\npod/alertmanager-59f9ddcccf-kbbvc         1/1     Running   0          22h\r\npod/blackbox-exporter-b74677477-f2sf5     1/1     Running   0          23h\r\npod/grafana-74bfb44dbf-6rtrn              1/1     Running   0          22h\r\npod/kube-state-metrics-5f6f7c9fbb-zcf6k   1/1     Running   0          23h\r\npod/node-exporter-4nxpb                   1/1     Running   0          23h\r\npod/node-exporter-xz5kq                   1/1     Running   0          23h\r\npod/prometheus-7f99f9888d-kdn9d           1/1     Running   0          16h\r\n\r\nNAME                         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE\r\nservice/alertmanager         NodePort    10.96.167.209   <none>        9093:31973/TCP   22h\r\nservice/blackbox-exporter    NodePort    10.96.179.56    <none>        9115:30115/TCP   23h\r\nservice/dingtalk             ClusterIP   10.96.168.175   <none>        8060/TCP         23h\r\nservice/grafana              NodePort    10.96.158.146   <none>        3000:31170/TCP   22h\r\nservice/kube-state-metrics   NodePort    10.96.106.100   <none>        8080:31493/TCP   23h\r\nservice/node-exporter        NodePort    10.96.215.144   <none>        9100:30181/TCP   22h\r\nservice/prometheus           NodePort    10.96.229.43    <none>        9090:32343/TCP   22h\r\n\r\nNAME                           DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE\r\ndaemonset.apps/node-exporter   1         1         1       1            1           <none>          23h\r\n\r\nNAME                                 READY   UP-TO-DATE   AVAILABLE   AGE\r\ndeployment.apps/alertmanager         1/1     1            1           22h\r\ndeployment.apps/blackbox-exporter    1/1     1            1           23h\r\ndeployment.apps/dingtalk             1/1     1            1           23h\r\ndeployment.apps/grafana              1/1     1            1           22h\r\ndeployment.apps/kube-state-metrics   1/1     1            1           23h\r\ndeployment.apps/prometheus           1/1     1            1           22h\r\n\r\nNAME                                            DESIRED   CURRENT   READY   AGE\r\nreplicaset.apps/alertmanager-59f9ddcccf         1         1         1       22h\r\nreplicaset.apps/blackbox-exporter-b74677477     1         1         1       23h\r\nreplicaset.apps/dingtalk-77d475cc8              1         1         1       23h\r\nreplicaset.apps/grafana-74bfb44dbf              1         1         1       22h\r\nreplicaset.apps/kube-state-metrics-5f6f7c9fbb   1         1         1       23h\r\nreplicaset.apps/kube-state-metrics-7d4b4fb7c8   1         1         1       23h\r\nreplicaset.apps/prometheus-7f99f9888d           1         1         1       22h\r\n\n"})}),"\n",(0,a.jsxs)(r.p,{children:["==访问prometheus：==浏览器输入",(0,a.jsx)(r.a,{href:"http://10.1.93.190:32343/targets",rel:"noopener noreferrer",target:"_blank",children:"http://10.1.93.190:32343/targets"}),"   （端口号视service而定）"]}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.img,{alt:"1616552351873",src:s})}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.img,{alt:"1616552817376",src:i})}),"\n",(0,a.jsxs)(r.p,{children:["==访问grafana：==浏览器输入",(0,a.jsx)(r.a,{href:"http://10.1.93.190:31170/targets",rel:"noopener noreferrer",target:"_blank",children:"http://10.1.93.190:31170/targets"}),"  （端口号视service而定）"]}),"\n",(0,a.jsx)(r.p,{children:"以下均未验证！！！"}),"\n",(0,a.jsxs)(r.p,{children:["数据源是",(0,a.jsx)(r.code,{children:"http://prometheus:32343"}),"，导入",(0,a.jsx)(r.code,{children:"主机详情"}),"模板8919，"]}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.img,{alt:"在这里插入图片描述",src:l})}),"\n",(0,a.jsx)(r.hr,{}),"\n",(0,a.jsxs)(r.h3,{id:"grafana配置kubernetes数据源",children:[(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#grafana配置kubernetes数据源",children:"#"}),"grafana配置kubernetes数据源"]}),"\n",(0,a.jsxs)(r.p,{children:["启动插件：",(0,a.jsx)(r.code,{children:"Plugins"})," → ",(0,a.jsx)(r.code,{children:"kubernetes"})," → ",(0,a.jsx)(r.code,{children:"Enable"}),"，然后配置集群访问地址及访问证书："]}),"\n",(0,a.jsxs)(r.p,{children:["如果是通过kubeadm方式搭建的k8s集群，会有一个 ",(0,a.jsx)(r.code,{children:"/etc/kubernetes/admin.conf"})," 文件，里面包含了客户端的证书和密码base64编码。"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{meta:""})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{meta:"",children:"cat /etc/kubernetes/admin.conf\r\napiVersion: v1clusters:- cluster:    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN5RENDQWJDZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJd01EVXhNakV3TURBek1Gb1hEVE13TURVeE1ERXdNREF6TUZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTDVpCmYxTGcxUUlqN0VlWlZ0cVFmS3dGZjg4V3NVbVVialZldll5NDZTUittMWpwRWdvM2wxWEIvZHBFNzRWOGtqTGQKZkdGdmVWZkVxNy8rMzdyamNGMXRpSm1BbThLZnMrMW9QdEpLOE0yZjNTSm5FZVVIQUlBeFl2cUE4ZFNsbThTQwpmSkJWU2J3K1pROTBTelpKNzdQUzFuZTBmYnRod0Y2VHE0Uy9FV3h3cUZZMzF5cENub05lVUNtcElsSjVnYWdtCnJ2QmhkTmFNb2oyQlRrMWNDVjh3dkRVS3RlbXFVYVE4R2ZCalZLeHhkdWtwcjJ3S3RPbXZkem1vMEdLSE11MFcKWmQ1TVd0dStIQVZrTXhzcE95Yk41NkFkNnloUkN5YkFJbTN2ZWJlTFV5cjBEY2JhNzJXNVlPRHRCY3ZBOEJxOAoxR1JQc1EwaXBUdGtYbDVCZEhzQ0F3RUFBYU1qTUNFd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFJS0lIb25wVllFWWpwR3JrN2wraGJyeGlxZXkKeGFQT1M3UW5TZEVZMC94TWtiUWxKcy9rUFcxU2lVemdoUk4wQWJxMnFtTXVuNHhlZ0pLdGVPNXhYRGJZNEhZbgpVVCtPWG0rQ1hBQjd3S3pYcDlmUTZBUDk3cmY0L2FRaXlGZEtsZUJ6Y3JNUkErZHZWTjk3NGlHUW94aFh3T1FNCmZXeGNrMDNhU0Qvc2s5UnJrcFhlL1g2NHQrV3BkUlFGRjE2YVFlSHVxNnJQRWZTR2VPUWVpcVIrQVgvdWpIOHoKZzJZY2JKWE85U3ZheXcyb3oxSlozTUx6K0FpeE5RTHFNYU00Tm43TklvMExxUHFqNzZoU3d1Qk1nREE0VnFtZAowZHRtS211OVZjTGZHcW9ITnZnajlTYlVlZ1crL3VEbzcwVXdvb2NGTmlnSnRnOVVSZWpEUXJJSm4rUT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=    server: https://192.168.30.188:6443  name: kubernetescontexts:- context:    cluster: kubernetes    user: kubernetes-admin  name: kubernetes-admin@kubernetescurrent-context: kubernetes-admin@kuberneteskind: Configpreferences: {}users:- name: kubernetes-admin  user:    client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM4akNDQWRxZ0F3SUJBZ0lJZWtMYS9Fc1ZDSGd3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TURBMU1USXhNREF3TXpCYUZ3MHlNVEExTVRJeE1EQXdNekphTURReApGekFWQmdOVkJBb1REbk41YzNSbGJUcHRZWE4wWlhKek1Sa3dGd1lEVlFRREV4QnJkV0psY201bGRHVnpMV0ZrCmJXbHVNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXJ2a084MUg0ZW9zak5kM3oKSy9UUEhHcGtCR1FvZm1hbm9ldjRlWXNmUTlPZW0wYzBvVUJ3cXoxM2JabmJUbmJweFFqbmdZMkc4bHF4UmkwaQpCdlA2ZmtmS0ZFQlZzUTd4dGlqZXBrdnByWEdPL08wUUE1U0k4NHJzTjVHOVhOa2pQbWdzYTBlblZxNUVvRTBGClRaNXpRRjlwUlkxWUZZZXYrTDE1bU5FaXlScUg4UDJRY3BoUmxWK09IUXVHaVdLNEhIRVB2QWw2QUpJeWN6d3MKWWMrdk1IdHlZbmF5NUMwUldVWHhyUmc0ZytKMksrY1h1YlF0elhXdjdxaTNhNjFDekpaZi9TZkNOd0Jyam9zRwp0b215WEJWNVZTVGJUYVk1OFZrLzFPK1NSc3BybjF3TDc0djdXUXVEaE9ydXhBRXpuYmRXWWxOMEZBMm5MTjlZCmwxWkVKUUlEQVFBQm95Y3dKVEFPQmdOVkhROEJBZjhFQkFNQ0JhQXdFd1lEVlIwbEJBd3dDZ1lJS3dZQkJRVUgKQXdJd0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFHazlIRDAxRmRRUnd4THhGUi8yRjdPM2ZpdGRFV3pDTC9UawpsZUxZaGlQaVh3NjNwOGtWU0VabEIyNEYzNEd2WlB3YS9LWnNUQnZXM0Mwek9uNGpHQ2hueHEvaVdqTWFnVEdBCktPUFV2bUI2VzhvVzhlb0lrSStOOEs0NFhSRnZzeGIwNUtqaCtwd0VZZzJUQXpBNEFlQzlnSjZYaTBzbHpnVnIKcWRzbXZtV0QzNEdXYzJOcVIzSDA3cW43RlJwRHIrTjlrTHE4Ukt4L0YwMWNCV1I3VVRZcnJTLzJEQ2t1N3lsWgptdTcwcXZicndYWnF6TkI5b05hQk82SHJsZXpuU2JQbnFKZUo0Q1czc2NMNmJ1N3A3bEppV1VQb0VHT0xic3YvCnFjT0xqdnZSRFF6eC9Xak5DWFZLNFhxbzJjVERGYitXeFJ1U2xGaUlQclk1QjlkQlFJWT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=    client-key-data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb2dJQkFBS0NBUUVBcnZrTzgxSDRlb3NqTmQzeksvVFBIR3BrQkdRb2ZtYW5vZXY0ZVlzZlE5T2VtMGMwCm9VQndxejEzYlpuYlRuYnB4UWpuZ1kyRzhscXhSaTBpQnZQNmZrZktGRUJWc1E3eHRpamVwa3ZwclhHTy9PMFEKQTVTSTg0cnNONUc5WE5ralBtZ3NhMGVuVnE1RW9FMEZUWjV6UUY5cFJZMVlGWWV2K0wxNW1ORWl5UnFIOFAyUQpjcGhSbFYrT0hRdUdpV0s0SEhFUHZBbDZBSkl5Y3p3c1ljK3ZNSHR5WW5heTVDMFJXVVh4clJnNGcrSjJLK2NYCnViUXR6WFd2N3FpM2E2MUN6SlpmL1NmQ053QnJqb3NHdG9teVhCVjVWU1RiVGFZNThWay8xTytTUnNwcm4xd0wKNzR2N1dRdURoT3J1eEFFem5iZFdZbE4wRkEybkxOOVlsMVpFSlFJREFRQUJBb0lCQUI4OHI0S1krN2RFNThCUwpJM3VSZFBncHRqbGllQ2c0dzJ5UTZBY3E0eVlFdmFnVENqNVBkczNiWjFyVndPVTlMWGJUcENEbzExS2xCa2owCi9jSW9CR3hPL0xDbzI2T0VlM3A5eVdIKzQzVG5kUk9LYnZWMHF3NXZtc1JBN0lHSzhsUE4zVUE1eHBJZkFubHIKeHFxWXd4S1c5Z0JJdjVUNGFGNEwxWTJHcUtNbUlhenVjLzVleU5rZjk3bnRyOFJncXQxcDJyaWJIVS9nRzFlYgpIWktyNm01UWx2MWJpYTFIYms2SWI2b1pYTVFIWWJSckpVemJSaWp6eE1RVkRmZ2tpalhSR3pSRjdZeVFZbTk5CmwwUzI1bDYzY1dIT3J6czM5R21xRmQ4Z0JJc0M3SkxuUThUY01nb1Axb0M5WXUzMGRrSDBvUi95M2lOTnFxRW8KZVJ2d0w0RUNnWUVBeG1tY2JDZXRlRDI5VWZDTE1kKzByTU14aVV4bHI3TTdrYUJOeWxPK2lOZWxKbUk5UHRXcwpkUzQzS2hkeElnSVNIQVRTdWxpR3VKMStEekxTWWNGZ2FkSmQxd25NNHppOUc2cW9NOXZTTVN2ZGtvK28ydXRqCmNscVBZcnVRbC9nK252dkE2N1ZyZzAyUXF0NFlqcmkrYmxQL1RNaDZGS3NGa0VQeXZPTHUxOTBDZ1lFQTRjSFgKUm43WUl2TWtMNGQrR3dkUmRwcXl5YStxVC9nbUtKTnNwb3VLUVZlaUd3aW9vR21BR0E0MEJBR2hyN24vMXB6Rwo5VkVQb201VDdPRnVmVWxGaUNURmJBblN2RWU5RTREUHJ3SDNhazlXR0JzcWxYcUZwMjdwWWFyZ3NSS2JDWU9UCm9Nc1FJR0wxelN4NEpkdFArMUxDQ1BuRnowMTNkajhRbmc4TVBPa0NnWUFwczF5cTVwUHc1NWo0dGNPcmtjYloKWUpUeXRGblMyYXExYXFtdTBuY0RMNytJRjdHam1Ta0wzOUM4U2Z6L0ZzeFRremZ1N2xneVNQZUxualRWVXQwKwpvSFlVa2Z5NzdOcmlDN1lhWUNNSExwNzlCTENLZ2xwK1dFWTJqQkZSdjF6NThST1U5cVpJREc5UldpaHpKcVR2CmJ6d0RHVWQvUElxSXpaOGd6OWsvQ1FLQmdIbEFRaDVEdkZReElNdENTM0c2NFg4QklXdC9wTXFrcmVIM0pGRGkKKzFPUy9LYm1aS01iWnNnRXdOMHgveVJCa3U0eWNBMk1Cd2lubHYzUUtpYXlOdDBqV3NGbkdUODBqSkd3Q2x1bApnN3dlZGxBbUx4M3ZtMTlOQzU0QVNBUHl5VUEzNGc5bllQYjBENjZ0NXEzMmQ2TzFWQys3N3dralF6bElMK1drCmtWOFpBb0dBVk01R1lLbnpNVjUzVzNXT3I0dFdLSm5XUHFiaHVlUEt5SXMzbTNkUzhGUE56SDU2UHhNKzRUM24Ka2NzT1VsZTlkQkFENXRXT3E5eHFmNWF4MXpaU2s1SzFhdUphSzRaa3RzNkdMRUgrU09WckdoK1JXQWtRcUFVbgo0Qmk4ZVA4MmR5M3N2RmV1UkNvTWFXRVQ0QlFHaGRQaFFCd1NNdlYrSWI2R3U0VldwN289Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==\n"})}),"\n",(0,a.jsxs)(r.p,{children:["其中属性",(0,a.jsx)(r.code,{children:"certificate-authority-data"}),"、",(0,a.jsx)(r.code,{children:"client-certificate-data"}),"、",(0,a.jsx)(r.code,{children:"client-key-data"})," 对应 CA 证书、Client 证书、Client 私钥，文件里面的内容是base64编码过后的，分别执行 ",(0,a.jsx)(r.code,{children:'echo "" | base64 -d'})," 就能还原成证书源文件。"]}),"\n",(0,a.jsxs)(r.p,{children:["首先将",(0,a.jsx)(r.code,{children:"Datasource"}),"设置为",(0,a.jsx)(r.code,{children:"Prometheus"}),"，"]}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.img,{alt:"在这里插入图片描述",src:o})}),"\n",(0,a.jsxs)(r.p,{children:["点击",(0,a.jsx)(r.code,{children:"Save"}),"保存即可，grafana中自动出现下图中的dashboard，"]}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.img,{alt:"在这里插入图片描述",src:c})}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.img,{alt:"在这里插入图片描述",src:m})}),"\n",(0,a.jsx)(r.p,{children:"K8s Cluster："}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.img,{alt:"在这里插入图片描述",src:p})}),"\n",(0,a.jsx)(r.p,{children:"K8s Node："}),"\n",(0,a.jsxs)(r.p,{children:["没有显示是因为prometheus的metric有更新，比如",(0,a.jsx)(r.code,{children:"node_cpu"}),"改成了",(0,a.jsx)(r.code,{children:"node_cpu_seconds_total"}),"。可以重新定义该dashboard的变量（可以参考8919 dashboard的变量），然后根据prometheus界面的metrics来调试。调试完毕示图："]}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.img,{alt:"在这里插入图片描述",src:d})}),"\n",(0,a.jsx)(r.p,{children:"K8s Deployments："}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.img,{alt:"在这里插入图片描述",src:h})}),"\n",(0,a.jsx)(r.p,{children:"K8s Container："}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.img,{alt:"在这里插入图片描述",src:u})}),"\n",(0,a.jsx)(r.p,{children:"grafana配置kubernetes数据源完成，接下来测试告警。"}),"\n",(0,a.jsx)(r.hr,{}),"\n",(0,a.jsxs)(r.h3,{id:"告警测试",children:[(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#告警测试",children:"#"}),"告警测试"]}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:"宕机测试："}),"\n"]}),"\n",(0,a.jsxs)(r.p,{children:["模拟node-exporter宕机，测试钉钉告警（",(0,a.jsx)(r.code,{children:"critical"}),"）是否正常。这里选择",(0,a.jsx)(r.code,{children:"node3"}),"作为测试机器。"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"vim kill_node-exporter.sh\n"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"#!/bin/bash\r\n \r\nnodepid=`netstat -lntp | grep 9100 | awk '{print $NF}' | awk -F '/' '{print $1}'`\r\nnodenum=`netstat -lntp | grep 9100 | grep -v pause | wc -l`\r\n \r\nif [ $nodenum -eq 0 ];then\r\n    exit\r\nelse\r\n    kill -9 $nodepid\r\n    exit\r\nfi\n"})}),"\n",(0,a.jsx)(r.p,{children:"等待3m，收到钉钉故障告警和恢复告警，"}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.img,{alt:"在这里插入图片描述",src:g})}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.img,{alt:"在这里插入图片描述",src:b})}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:"CPU测试："}),"\n"]}),"\n",(0,a.jsxs)(r.p,{children:["模拟CPU使用率为80%，测试邮件告警（",(0,a.jsx)(r.code,{children:"warning"}),")是否正常。这里选择",(0,a.jsx)(r.code,{children:"node3"}),"作为测试机器。"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",meta:"",children:"yum install -y stress-ng stress-ng -c 0 -l 80            \r\n# -c 指定压力源进程的数量，以匹配在线CPU的数量，0表示加载每个cpu；-l 指定CPU使用率；Ctrl + C 退出\n"})}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.img,{alt:"在这里插入图片描述",src:x})}),"\n",(0,a.jsx)(r.p,{children:"等待5m，收到邮件故障告警和恢复告警，"}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.img,{alt:"在这里插入图片描述",src:f})}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.img,{alt:"在这里插入图片描述",src:_})}),"\n",(0,a.jsx)(r.p,{children:"测试钉钉和邮件告警均没有问题。更多关于k8s集群的指标监控可以自行配置，此处仅作为演示。"}),"\n",(0,a.jsxs)(r.p,{children:["k8s以Deployment方式部署 prometheus + grafana 完成。生产环境建议使用StatefulSet方式部署集群，大致过程与上面类似。已存放至个人gitee：",(0,a.jsx)(r.a,{href:"https://gitee.com/xinbadayt/prometheus.git",rel:"noopener noreferrer",target:"_blank",children:"https://gitee.com/xinbadayt/prometheus.git"})]}),"\n",(0,a.jsxs)(r.p,{children:["转载至",(0,a.jsx)(r.a,{href:"https://blog.csdn.net/miss1181248983/article/details/107673128",rel:"noopener noreferrer",target:"_blank",children:"https://blog.csdn.net/miss1181248983/article/details/107673128"})]})]})}function v(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:r}=Object.assign({},(0,t.ah)(),e.components);return r?(0,a.jsx)(r,Object.assign({},e,{children:(0,a.jsx)(k,e)})):k(e)}let N=v;v.__RSPRESS_PAGE_META={},v.__RSPRESS_PAGE_META["tang%2FPrometheus%2F1.md"]={toc:[{id:"namespace",text:"namespace",depth:3},{id:"node-exporter",text:"node-exporter",depth:3},{id:"k8s组件",text:"k8s组件",depth:3},{id:"kube-state-metrics",text:"kube-state-metrics",depth:3},{id:"blackbox-exporter",text:"blackbox-exporter",depth:3},{id:"dingtalk",text:"dingtalk",depth:3},{id:"alertmanager",text:"alertmanager",depth:3},{id:"prometheus",text:"prometheus",depth:3},{id:"grafana",text:"grafana",depth:3},{id:"部署",text:"部署",depth:3},{id:"grafana配置kubernetes数据源",text:"grafana配置kubernetes数据源",depth:3},{id:"告警测试",text:"告警测试",depth:3}],title:"k8s部署prometheus + grafana",headingTitle:"k8s部署prometheus + grafana",frontmatter:{}}}}]);