"use strict";(self.webpackChunkmy_doc=self.webpackChunkmy_doc||[]).push([["388"],{11968:function(e,n,r){r.r(n),r.d(n,{default:function(){return c}});var s=r(85893),i=r(50065);function d(e){let n=Object.assign({h1:"h1",a:"a",h2:"h2",blockquote:"blockquote",p:"p",pre:"pre",code:"code",ul:"ul",li:"li",strong:"strong",h3:"h3",em:"em"},(0,i.ah)(),e.components);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.h1,{id:"17-触发器",children:["17 触发器",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#17-触发器",children:"#"})]}),"\n",(0,s.jsxs)(n.h2,{id:"171-定义触发器",children:["17.1 定义触发器",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#171-定义触发器",children:"#"})]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"语法"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-mysql",children:"CREATE TRIGGER 触发器名称\r\n{BEFORE|AFTER} {INSERT|UPDATE|DELETE} ON 表名\r\nFOR EACH ROW\r\n触发器执行的语句块;\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"BEFORE|AFTER"}),"：二选一"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"BEFORE"}),"：表示在事件发生之前执行当前触发器"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"AFTER"}),"：表示在事件发生之后之执行触发器。",(0,s.jsx)(n.strong,{children:"不允许在触发后更新new行和old行"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"INSERT|UPDATE|DELETE"}),"：三选一，表名事件类型"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"INSERT"}),"：使用",(0,s.jsx)(n.code,{children:"NEW"}),"(或",(0,s.jsx)(n.code,{children:"new"}),")代表当前要插入的对象"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"DELETE"}),"：使用",(0,s.jsx)(n.code,{children:"OLD"}),"(或",(0,s.jsx)(n.code,{children:"old"}),")代表当前要删除的对象"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"UPDATE"}),"：",(0,s.jsx)(n.code,{children:"NEW"}),"(或",(0,s.jsx)(n.code,{children:"new"}),")和",(0,s.jsx)(n.code,{children:"OLD"}),"(或",(0,s.jsx)(n.code,{children:"old"}),")都可以用。"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"FOR EACH ROW"}),"：表示每一行都要执行触发器"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"触发器执行的语句块"}),"：可以是一行sql语句，也可以是复杂的",(0,s.jsx)(n.code,{children:"BEGIN ... END"}),"语句"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"同表的更新不能在触发器中使用update，而是直接使用set。相当于给new或old对象进行赋值操作"}),"。"]}),"\n",(0,s.jsxs)(n.p,{children:["例子：16.5--\x3e",(0,s.jsx)(n.code,{children:"代码"}),"--\x3e ②和⑤"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.h2,{id:"172-查看触发器",children:["17.2 查看触发器",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#172-查看触发器",children:"#"})]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"查看当前数据库所有的触发器"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-mysql",children:"SHOW TRIGGERS;\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"查看当前数据库指定触发器的定义"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-mysql",children:"SHOW CREATE TRIGGER 触发器名\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"从系统库information_schema的TRIGGERS表中查询触发器的信息"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-mysql",children:"SELECT * FROM information_schema.TRIGGERS [WHERE 字句];\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.h2,{id:"173-删除触发器",children:["17.3 删除触发器",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#173-删除触发器",children:"#"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-mysql",children:"DROP TRIGGER IF EXISTS 触发器名称;\n"})}),"\n",(0,s.jsxs)(n.h2,{id:"174-中断触发器的执行",children:["17.4 中断触发器的执行",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#174-中断触发器的执行",children:"#"})]}),"\n",(0,s.jsxs)(n.p,{children:["可以使用",(0,s.jsx)(n.code,{children:"SIGNAL"}),"语句抛出异常，中断触发器的执行，并提供错误信息。"]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"语法"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-mysql",children:"SIGNAL condition_value\r\n    [SET condition_information_item_name = 值 [, condition_information_item_name = 值, ...]];\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"condition_value"}),"可选值如下：","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"SQLSTATE '长度为5的字符串类型的错误代码'"}),"：其中'错误码'不能是00（表示成功）和01（表示警告）开头，因为二者不会中断执行。"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"事先用DECLARE自定义的条件名称"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"condition_information_item_name"}),"可选值如下：","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"MESSAGE_TEXT"}),"：对应的值为错误描述信息"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"MYSQL_ERRNO"}),"：对应的值为数值型的错误代码"]}),"\n",(0,s.jsx)(n.li,{children:"..."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-mysql",children:"delimiter $\r\ncreate trigger salary_check_trigger\r\nbefore insert on emps\r\nfor each row\r\nbegin\r\n	declare mgr_sal double;\r\n	select salary into mgr_sal from emps where employee_id = NEW.manager_id;\r\n	\r\n	if NEW.salary > mgr_sal \r\n		then SIGNAL SQLSTATE 'HY000' SET MESSAGE_TEXT = '薪资高于领导薪资错误', MYSQL_ERRNO = 1644;\r\n	end if;\r\nend $\r\ndelimiter ;\n"})}),"\n",(0,s.jsxs)(n.h2,{id:"175-触发器的优缺点",children:["17.5 触发器的优缺点",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#175-触发器的优缺点",children:"#"})]}),"\n",(0,s.jsxs)(n.h3,{id:"1751-优点",children:["17.5.1 优点",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#1751-优点",children:"#"})]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"可以确保数据的完整性"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"可以帮助我们记录日志操作"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"可以在操作数据前，对数据进行合法性检查"})}),"\n"]}),"\n",(0,s.jsxs)(n.h3,{id:"1752-缺点",children:["17.5.2 缺点",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#1752-缺点",children:"#"})]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"可读性差"}),"。因为触发器存储在数据库中，并且由事件驱动，这就意味着触发器有可能",(0,s.jsx)(n.code,{children:"不受应用层的控制"}),"。"]}),"\n",(0,s.jsx)(n.p,{children:"比如，在给t_user表中插入用户信息时，需要更新t_user_log表。当t_user_log中的remark字段过长，触发器会报错。但是t_user表中并没有remark字段。如果你不了解这个触发器， 很可能会认为是更新语句本身的问题"}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"**相关数据的变更，可能会导致触发器出错。**特别是数据表结构的变更，都可能会导致触发器出错，进而影响数据操作的正常运行。这些都会由于触 发器本身的隐蔽性，影响到应用中错误原因排查的效率"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.h2,{id:"176-触发器使用例子",children:["17.6 触发器使用例子",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#176-触发器使用例子",children:"#"})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"例"}),"创建t_user表，t_user_log表。"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"①在插入用户信息后，使用触发器，自动插入create_time、update_time字段，并且在t_user_log表中插入日志"}),"\n",(0,s.jsx)(n.li,{children:"②在更新用户信息前，使用触发器，自动更新update_time字段，并且在t_user_log表中插入日志"}),"\n",(0,s.jsx)(n.li,{children:"③在删除用户信息后，使用触发器，在t_user_log表中插入日志"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.code,{children:"代码"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"①创建t_user表，t_user_log表"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-mysql",children:"create table t_user(\r\n	id int primary key auto_increment,\r\n	user_name VARCHAR(25),\r\n	create_time datetime,\r\n	update_time datetime\r\n);\r\ncreate table t_user_log(\r\n	id int primary key auto_increment,\r\n	user_id int,\r\n	user_name_old varchar(25),\r\n	user_name_new varchar(25),\r\n	type enum('1', '2', '3') default '1' comment '1插入2更新3删除' ,\r\n	remark varchar(25),\r\n	create_time datetime\r\n);\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["②创建触发器",(0,s.jsx)(n.code,{children:"t_user_before_insert_trigger"}),"，在插入用户信息时，自动填充create_time和update_time"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-mysql",children:"# 触发器作用：在插入用户信息时，自动填充create_time和update_time\r\n# 使用before的原因：不允许在触发后，更新new行和old行\r\ndelimiter $\r\ncreate trigger t_user_before_insert_trigger\r\nbefore insert on t_user\r\nfor each row\r\nbegin \r\n	# 同表的更新不能用update，而是直接使用set\r\n	# 可以理解为：\r\n	# 	①在插入之前中还没有当前记录，所以无法使用update（因为update需要根据id或其他字段定位）\r\n	# 	②使用set给当前对象（new）进行赋值，在插入时当前对象的create_time、update_time就有值了\r\n	set new.create_time = now(), new.update_time = now(); \r\nend $\r\ndelimiter ;\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["③创建触发器",(0,s.jsx)(n.code,{children:"t_user_after_insert_trigger"}),"，在插入用户信息时，使用日志表t_user_log记录操作日志"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-mysql",children:"# 触发器作用：在插入用户信息后，使用日志表t_user_log记录操作日志\r\ndelimiter $\r\ncreate trigger t_user_after_insert_trigger\r\nafter insert on t_user\r\nfor each row\r\nbegin\r\n	insert into t_user_log(user_id, user_name_new, type, remark, create_time)\r\n	values (new.id, new.user_name, 1, '插入用户信息', now());\r\nend $\r\ndelimiter ;\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"④插入数据验证"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-mysql",children:"# 插入数据\r\ninsert into t_user(user_name) values('Tom');\r\n# 验证\r\nselect * from t_user;\r\nselect * from t_user_log;\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["⑤创建触发器",(0,s.jsx)(n.code,{children:"t_user_before_update_trigger"}),"，在更新用户信息时，自动更新update_time"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-mysql",children:"# 触发器作用：在更新用户信息时，自动更新update_time\r\n# 使用before的原因：不允许在触发后更新new行和old行\r\ndelimiter $\r\ncreate trigger t_user_before_update_trigger\r\nbefore update on t_user\r\nfor each row\r\nbegin\r\n	set new.update_time = now();\r\nend $\r\ndelimiter ;\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["⑥创建触发器",(0,s.jsx)(n.code,{children:"t_user_after_update_trigger"}),"，使用日志表t_user_log记录操作日志"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-mysql",children:"# 触发器作用：在更新用户信息后，使用日志表t_user_log记录操作日志\r\ndelimiter $\r\ncreate trigger t_user_after_update_trigger\r\nafter update on t_user\r\nfor each row\r\nbegin\r\n	insert into t_user_log(user_id, user_name_old, user_name_new, type, remark, create_time)\r\n	values (new.id, old.user_name, new.user_name, 2, '更新用户信息', now());\r\nend $\r\ndelimiter ;\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"⑦更新数据验证"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-mysql",children:"# 更新数据\r\nupdate t_user set user_name = 'Tom1' where id = 1;\r\n# 验证\r\nselect * from t_user;\r\nselect * from t_user_log;\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["⑧创建触发器",(0,s.jsx)(n.code,{children:"t_user_after_delete_trigger"}),"，在删除数据后，使用日志表t_user_log记录操作日志"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-mysql",children:"# 触发器作用：在删除数据后，使用日志表t_user_log记录操作日志\r\ndelimiter $\r\ncreate trigger t_user_after_delete_trigger\r\nafter delete on t_user\r\nfor each row\r\nbegin\r\n	insert into t_user_log(user_id, user_name_old, type, remark, create_time)\r\n	values (old.id, old.user_name, 3, '删除用户信息', now());\r\nend $\r\ndelimiter ;\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"⑨删除数据验证"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-mysql",children:"# 删除数据\r\ndelete from t_user where id = 1;\r\n# 验证\r\nselect * from t_user;\r\nselect * from t_user_log;\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.h2,{id:"177-触发器使用注意事项",children:["17.7 触发器使用注意事项",(0,s.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#177-触发器使用注意事项",children:"#"})]}),"\n",(0,s.jsxs)(n.p,{children:["如果在子表中定义了",(0,s.jsx)(n.em,{children:"外键约束"}),"，并且外键指定了",(0,s.jsx)(n.code,{children:"ON UPDATE"}),"/",(0,s.jsx)(n.code,{children:"DELETE CASCADE"}),"/",(0,s.jsx)(n.code,{children:"SET NULL"}),"子句，此时",(0,s.jsx)(n.em,{children:"修改父表被引用的键值或删除父表被引用的记录行"}),"时，也会引起子表的修改和删除操作，此时",(0,s.jsx)(n.strong,{children:"基于子表的UPDATE和DELETE语句定义的触发器并不会被激活"})]})]})}function l(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,i.ah)(),e.components);return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}let c=l;l.__RSPRESS_PAGE_META={},l.__RSPRESS_PAGE_META["tang%2Fmysql%2F17_%E8%A7%A6%E5%8F%91%E5%99%A8.md"]={toc:[{text:"17.1 定义触发器",id:"171-定义触发器",depth:2},{text:"17.2 查看触发器",id:"172-查看触发器",depth:2},{text:"17.3 删除触发器",id:"173-删除触发器",depth:2},{text:"17.4 中断触发器的执行",id:"174-中断触发器的执行",depth:2},{text:"17.5 触发器的优缺点",id:"175-触发器的优缺点",depth:2},{text:"17.5.1 优点",id:"1751-优点",depth:3},{text:"17.5.2 缺点",id:"1752-缺点",depth:3},{text:"17.6 触发器使用例子",id:"176-触发器使用例子",depth:2},{text:"17.7 触发器使用注意事项",id:"177-触发器使用注意事项",depth:2}],title:"17 触发器",frontmatter:{}}}}]);