import{_ as s,o as n,c as a,b as e}from"./app-DRxAhH5h.js";const t="/assets/k8s-connect-refused-Ds7mH8pG.png",p={},c=e('<h1 id="_6443-connect-refused" tabindex="-1"><a class="header-anchor" href="#_6443-connect-refused"><span>6443_connect-refused</span></a></h1><h1 id="错误信息" tabindex="-1"><a class="header-anchor" href="#错误信息"><span>错误信息</span></a></h1><p>The connection to the server 192.168.100.170:6443 was refused</p><p><img src="'+t+`" alt="k8s-connect-refused"></p><h1 id="解决步骤" tabindex="-1"><a class="header-anchor" href="#解决步骤"><span>解决步骤</span></a></h1><p>参考文档：https://www.jianshu.com/p/6edc9f171df1</p><h2 id="step1-查看6443端口是否正常或者是否开启防火墙" tabindex="-1"><a class="header-anchor" href="#step1-查看6443端口是否正常或者是否开启防火墙"><span>step1. 查看6443端口是否正常或者是否开启防火墙</span></a></h2><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line"><span class="token function">netstat</span> <span class="token parameter variable">-pnlt</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">6443</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 如果提示 netstat： </span></span>
<span class="line">yum <span class="token function">install</span> net-tools</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行之后什么都没有返回，也就是说 <strong>APIServer 完全没有提供服务</strong>，那我们就去查看一下 kubelet 的日志，大家都知道使用 kubeadm 搭建的 k8s集群里，APIServer 都是在 docker 里运行的，这里我们先找到对应的容器，记得加 <code>-a</code>，因为该容器可能已经处于非正常状态了。</p><h2 id="step2-查看apiserver" tabindex="-1"><a class="header-anchor" href="#step2-查看apiserver"><span>step2.查看APIServer</span></a></h2><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line"><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span> <span class="token operator">|</span> <span class="token function">grep</span> apiserver</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 输出</span></span>
<span class="line">f40d97ee2be6        40a63db91ef8                                                    <span class="token string">&quot;kube-apiserver --au…&quot;</span>   <span class="token number">2</span> minutes ago        Exited <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token number">2</span> minutes ago                            k8s_kube-apiserver_kube-apiserver-master1_kube-system_7beef975d93d634ecee05282d3d3a9ac_718</span>
<span class="line">4b866fe71e33        registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1   <span class="token string">&quot;/pause&quot;</span>                 <span class="token number">2</span> days ago           Up <span class="token number">2</span> days                                             k8s_POD_kube-apiserver-master1_kube-system_7beef975d93d634ecee05282d3d3a9ac_0</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里能看到两个容器，可以看到 <strong>容器的状态已经是 <code>Exited</code> 了</strong>，注意下面的<code>pause</code>容器，这个只是用来引导 APIServer 的，并不是服务的实际运行容器，所以看不到日志，所以查看日志时不要输错容器 id 了。接下来查看 APIServer 的日志。</p><h2 id="step3-查看apiserver-的日志" tabindex="-1"><a class="header-anchor" href="#step3-查看apiserver-的日志"><span>Step3.查看APIServer 的日志</span></a></h2><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line"><span class="token function">docker</span> logs <span class="token parameter variable">-f</span> f40d97ee2be6</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 输出</span></span>
<span class="line">I1230 01:39:42.942786       <span class="token number">1</span> server.go:557<span class="token punctuation">]</span> external <span class="token function">host</span> was not specified, using <span class="token number">192.168</span>.100.171</span>
<span class="line">I1230 01:39:42.942924       <span class="token number">1</span> server.go:146<span class="token punctuation">]</span> Version: v1.13.1</span>
<span class="line">I1230 01:39:43.325424       <span class="token number">1</span> plugins.go:158<span class="token punctuation">]</span> Loaded <span class="token number">8</span> mutating admission controller<span class="token punctuation">(</span>s<span class="token punctuation">)</span> successfully <span class="token keyword">in</span> the following order: NamespaceLifecycle,LimitRanger,ServiceAccount,NodeRestriction,Priority,DefaultTolerationSeconds,DefaultStorageClass,MutatingAdmissionWebhook.</span>
<span class="line">I1230 01:39:43.325451       <span class="token number">1</span> plugins.go:161<span class="token punctuation">]</span> Loaded <span class="token number">6</span> validating admission controller<span class="token punctuation">(</span>s<span class="token punctuation">)</span> successfully <span class="token keyword">in</span> the following order: LimitRanger,ServiceAccount,Priority,PersistentVolumeClaimResize,ValidatingAdmissionWebhook,ResourceQuota.</span>
<span class="line">I1230 01:39:43.326327       <span class="token number">1</span> plugins.go:158<span class="token punctuation">]</span> Loaded <span class="token number">8</span> mutating admission controller<span class="token punctuation">(</span>s<span class="token punctuation">)</span> successfully <span class="token keyword">in</span> the following order: NamespaceLifecycle,LimitRanger,ServiceAccount,NodeRestriction,Priority,DefaultTolerationSeconds,DefaultStorageClass,MutatingAdmissionWebhook.</span>
<span class="line">I1230 01:39:43.326340       <span class="token number">1</span> plugins.go:161<span class="token punctuation">]</span> Loaded <span class="token number">6</span> validating admission controller<span class="token punctuation">(</span>s<span class="token punctuation">)</span> successfully <span class="token keyword">in</span> the following order: LimitRanger,ServiceAccount,Priority,PersistentVolumeClaimResize,ValidatingAdmissionWebhook,ResourceQuota.</span>
<span class="line">F1230 01:40:03.328865       <span class="token number">1</span> storage_decorator.go:57<span class="token punctuation">]</span> Unable to create storage backend: config <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">{</span> /registry <span class="token punctuation">[</span>https://127.0.0.1:2379<span class="token punctuation">]</span> /etc/kubernetes/pki/apiserver-etcd-client.key /etc/kubernetes/pki/apiserver-etcd-client.crt /etc/kubernetes/pki/etcd/ca.crt <span class="token boolean">true</span> 0xc0004bd440 <span class="token operator">&lt;</span>nil<span class="token operator">&gt;</span> 5m0s 1m0s<span class="token punctuation">}</span><span class="token punctuation">)</span>, err <span class="token punctuation">(</span>dial tcp <span class="token number">127.0</span>.0.1:2379: connect: connection refused<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从最后一行可以看到，是 APIServer 在尝试创建存储时出现了问题，导致无法正确启动服务，由于 k8s 是使用 etcd 作为存储的，所以我们再来查看 etcd 的日志 。</p><h2 id="step4-查看etcd日志" tabindex="-1"><a class="header-anchor" href="#step4-查看etcd日志"><span>Step4.查看etcd日志</span></a></h2><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="line"><span class="token comment"># 查看 etcd 容器，注意 etcd 也有对应的 pause 容器</span></span>
<span class="line"><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span> <span class="token operator">|</span> <span class="token function">grep</span> etcd</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 输出</span></span>
<span class="line">1b8b522ee4e8        3cab8e1b9802                                                    <span class="token string">&quot;etcd --advertise-cl…&quot;</span>   <span class="token number">7</span> minutes ago        Exited <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token number">6</span> minutes ago                              k8s_etcd_etcd-master1_kube-system_1051dec0649f2b816946cb1fea184325_942</span>
<span class="line">c9440543462e        registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1   <span class="token string">&quot;/pause&quot;</span>                 <span class="token number">2</span> days ago           Up <span class="token number">2</span> days                                             k8s_POD_etcd-master1_kube-system_1051dec0649f2b816946cb1fea184325_0</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 查看 etcd 日志</span></span>
<span class="line"><span class="token function">docker</span> logs <span class="token parameter variable">-f</span> 1b8b522ee4e8</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 输出</span></span>
<span class="line"><span class="token punctuation">..</span>.</span>
<span class="line"><span class="token number">2021</span>-03-24 03:10:27.339748 I <span class="token operator">|</span> embed: initial advertise peer URLs <span class="token operator">=</span> https://10.1.93.160:2380</span>
<span class="line"><span class="token number">2021</span>-03-24 03:10:27.339752 I <span class="token operator">|</span> embed: initial cluster <span class="token operator">=</span></span>
<span class="line"><span class="token number">2021</span>-03-24 03:10:27.339927 W <span class="token operator">|</span> pkg/fileutil: check <span class="token function">file</span> permission: directory <span class="token string">&quot;/var/lib/etcd/member/snap&quot;</span> exist, but the permission is <span class="token string">&quot;drwxr-xr-x&quot;</span><span class="token builtin class-name">.</span> The recommendedo the data.</span>
<span class="line"><span class="token number">2021</span>-03-24 03:10:27.950522 I <span class="token operator">|</span> etcdserver: recovered store from snapshot at index <span class="token number">11841307</span></span>
<span class="line"><span class="token number">2021</span>-03-24 03:10:27.951270 I <span class="token operator">|</span> mvcc: restore compact to <span class="token number">11013220</span></span>
<span class="line"><span class="token number">2021</span>-03-24 03:10:27.958062 E <span class="token operator">|</span> wal: failed to allocate space when creating new wal <span class="token function">file</span> <span class="token punctuation">(</span>no space left on device<span class="token punctuation">)</span></span>
<span class="line"><span class="token number">2021</span>-03-24 03:10:28.111238 C <span class="token operator">|</span> etcdserver: <span class="token builtin class-name">read</span> wal error <span class="token punctuation">(</span>no space left on device<span class="token punctuation">)</span> and cannot be repaired</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从最后一行可以看出，<code>no space left on device</code>，表示磁盘空间不够了。解决方法，要么是删掉虚拟机中无用文件，要么是给虚拟机增加内存。</p>`,18),l=[c];function i(o,r){return n(),a("div",null,l)}const u=s(p,[["render",i],["__file","6443_connect-refused.html.vue"]]),m=JSON.parse('{"path":"/static/tang/k8s/%E9%94%99%E8%AF%AF%E9%9B%86%E9%94%A6/6443_connect-refused.html","title":"6443_connect-refused","lang":"zh-CN","frontmatter":{},"headers":[{"level":2,"title":"step1. 查看6443端口是否正常或者是否开启防火墙","slug":"step1-查看6443端口是否正常或者是否开启防火墙","link":"#step1-查看6443端口是否正常或者是否开启防火墙","children":[]},{"level":2,"title":"step2.查看APIServer","slug":"step2-查看apiserver","link":"#step2-查看apiserver","children":[]},{"level":2,"title":"Step3.查看APIServer 的日志","slug":"step3-查看apiserver-的日志","link":"#step3-查看apiserver-的日志","children":[]},{"level":2,"title":"Step4.查看etcd日志","slug":"step4-查看etcd日志","link":"#step4-查看etcd日志","children":[]}],"git":{},"filePathRelative":"static/tang/k8s/错误集锦/6443_connect-refused.md"}');export{u as comp,m as data};
